"use strict";
var rxjs_1 = require("rxjs");
var jsondiffpatch = require("jsondiffpatch");
var rxjs_adapter_1 = require("@cycle/rxjs-adapter");
var g_unanchoredLedger = {};
function fromEvent(diffMap, eventName) {
    return rxjs_1.Observable.create(function (observer) {
        var handler = function (e) { return observer.next(e); };
        diffMap.on(eventName, handler);
        return function () { return diffMap.off(eventName, handler); };
    });
}
function diff(previous, current) {
    return jsondiffpatch.diff(previous, current);
}
function patch(diffMap, previousDescriptor, descriptor) {
    var delta = diff(previousDescriptor, descriptor);
    // console.log(`previous`, previousDescriptor)
    // console.log(`current`, descriptor)
    // console.log(`delta`, delta)
    if (delta) {
        var controls = delta.controls, map = delta.map, sources = delta.sources, layers = delta.layers, canvas = delta.canvas, options = delta.options;
        if (controls) {
            patchControls(diffMap, controls, descriptor.controls);
        }
        if (map) {
            patchMap(diffMap, map, descriptor.map, options);
        }
        if (sources) {
            patchSources(diffMap, sources, descriptor.sources);
        }
        if (layers) {
            patchLayers(diffMap, layers, descriptor.layers);
        }
        if (canvas) {
            patchCanvas(diffMap, canvas, descriptor.canvas);
        }
    }
    return descriptor;
}
function patchMap(diffMap, mapDelta, mapDescriptor, options) {
    if (mapDelta.zoom) {
        diffMap.easeTo({
            center: diffMap.getCenter(),
            zoom: mapDescriptor.zoom
        });
    }
    if (mapDelta.center) {
        var newCenter = mapDescriptor.center;
        if (options && options.offset) {
            var _a = options.offset, x = _a[0], y = _a[1];
            var coordinates = diffMap.project(mapDescriptor.center);
            var shiftedCenter = coordinates.sub({ x: x, y: y });
            newCenter = diffMap.unproject(shiftedCenter);
        }
        diffMap.easeTo({
            center: newCenter,
            zoom: diffMap.getZoom()
        });
    }
    if (mapDelta.dragPan) {
        //console.log(`dragPan`, mapDescriptor.dragPan)
        if (mapDescriptor.dragPan) {
            //console.log(`enabling drag`)
            diffMap.dragPan.enable();
        }
        else {
            //console.log(`disabling drag`)
            diffMap.dragPan.disable();
        }
    }
}
function patchSources(diffMap, delta, descriptor) {
    if (delta) {
        if (Array.isArray(delta)) {
            var len = delta.length;
            var vals = void 0;
            switch (len) {
                case 1:
                    vals = delta[0];
                    for (var key in vals) {
                        if (vals.hasOwnProperty(key)) {
                            var data = vals[key];
                            diffMap.addSource(key, data);
                        }
                    }
                    break;
                case 2:
                    vals = delta[0];
                    for (var key in vals) {
                        if (vals.hasOwnProperty(key)) {
                            diffMap.removeSource(key);
                            diffMap.addSource(key, descriptor[key]);
                        }
                    }
                    break;
                case 3:
                    vals = delta[0];
                    for (var key in vals) {
                        if (vals.hasOwnProperty(key)) {
                            diffMap.removeSource(key);
                        }
                    }
                    break;
                default:
                    throw new Error("Invalid delta length");
            }
        }
        else {
            for (var key in delta) {
                var newData = descriptor[key].data;
                diffMap.getSource(key).setData(newData);
            }
        }
    }
}
function patchLayers(diffMap, delta, descriptor) {
    if (delta) {
        if (Array.isArray(delta)) {
            var len = delta.length;
            var vals = void 0;
            switch (len) {
                case 1:
                    vals = delta[0];
                    for (var key in vals) {
                        if (vals.hasOwnProperty(key)) {
                            var data = vals[key];
                            diffMap.addLayer(data);
                        }
                    }
                    break;
                case 2:
                    vals = delta[0];
                    for (var key in vals) {
                        if (vals.hasOwnProperty(key)) {
                            diffMap.removeLayer(key);
                            diffMap.addLayer(descriptor[key]);
                        }
                    }
                    break;
                case 3:
                    vals = delta[0];
                    for (var key in vals) {
                        if (vals.hasOwnProperty(key)) {
                            diffMap.removeLayer(key);
                        }
                    }
                    break;
                default:
                    throw new Error("Invalid delta length");
            }
        }
    }
}
function patchControls(diffMap, delta, descriptor) {
}
function patchCanvas(diffMap, delta, descriptor) {
    if (delta) {
        if (descriptor.style && descriptor.style.cursor) {
            diffMap.getCanvas().style.cursor = descriptor.style.cursor;
        }
    }
}
function diffAndPatch(descriptor) {
    if (typeof descriptor === "undefined" || !descriptor) {
        return undefined;
    }
    var anchorId = descriptor.map.container;
    var anchor = document.getElementById(anchorId);
    if (!anchor) {
        g_unanchoredLedger[anchorId] = descriptor;
        return rxjs_1.Observable.never();
    }
    else {
        var diffMap_1 = anchor.diffMap;
        if (!diffMap_1) {
            var controls_1 = descriptor.controls, map = descriptor.map, sources_1 = descriptor.sources, layers_1 = descriptor.layers, canvas_1 = descriptor.canvas, options_1 = descriptor.options;
            diffMap_1 = new mapboxgl.Map(descriptor.map);
            return rxjs_1.Observable.create(function (observer) {
                diffMap_1.on('load', function () {
                    /*** HACK to allow for enable/disable from outset */
                    diffMap_1.dragPan.disable();
                    diffMap_1.dragPan.enable();
                    /*** End HACK */
                    if (controls_1) {
                    }
                    if (sources_1) {
                        for (var key in sources_1) {
                            if (sources_1.hasOwnProperty(key)) {
                                diffMap_1.addSource(key, sources_1[key]);
                            }
                        }
                    }
                    if (layers_1) {
                        for (var key in layers_1) {
                            if (layers_1.hasOwnProperty(key)) {
                                diffMap_1.addLayer(layers_1[key]);
                            }
                        }
                    }
                    if (canvas_1) {
                        if (canvas_1.style && canvas_1.style.cursor) {
                            diffMap_1.getCanvas().style.cursor = canvas_1.style.cursor;
                        }
                    }
                    if (options_1 && options_1.offset) {
                        var _a = options_1.offset, x = _a[0], y = _a[1];
                        var coordinates = diffMap_1.project(diffMap_1.getCenter());
                        var shiftedCenter = coordinates.sub({ x: x, y: y });
                        var newCenter = diffMap_1.unproject(shiftedCenter);
                        diffMap_1.setCenter(newCenter);
                    }
                    ;
                    anchor.diffMap = diffMap_1;
                    anchor.previousDescriptor = descriptor;
                    observer.next(descriptor);
                    observer.complete();
                });
            });
        }
        else {
            var processing = anchor.diffMapProcessing;
            if (!processing) {
                ;
                anchor.diffMapProcessing = true;
                var previousDescriptor = anchor.previousDescriptor;
                var out = rxjs_1.Observable.of(patch(diffMap_1, previousDescriptor, descriptor));
                anchor.previousDescriptor = descriptor;
                anchor.diffMapProcessing = false;
                var queued = anchor.descriptorQueue;
                if (queued && Array.isArray(queued) && queued.length) {
                    var d = queued.shift();
                    return diffAndPatch(d);
                }
                return out;
            }
            else {
                var queued = anchor.descriptorQueue;
                if (queued && Array.isArray(queued)) {
                    queued.push(descriptor);
                }
                else {
                    ;
                    anchor.descriptorQueue = [descriptor];
                }
                return rxjs_1.Observable.never();
            }
        }
    }
}
function renderRawRootElem$(descriptor$, accessToken) {
    var mutation$ = rxjs_1.Observable.create(function (observer) {
        var mObserver = new MutationObserver(function (m) { return observer.next(m); });
        var config = { childList: true, subtree: true };
        mObserver.observe(document, config);
        return function () { mObserver.disconnect(); };
    });
    var fromMutation$ = mutation$
        .switchMap(function () {
        var anchorId;
        var buffer = [];
        for (anchorId in g_unanchoredLedger) {
            var anchor = document.getElementById(anchorId);
            if (anchor) {
                var cachedDescriptor = g_unanchoredLedger[anchorId];
                delete g_unanchoredLedger[anchorId];
                buffer.push(cachedDescriptor);
            }
        }
        if (buffer.length) {
            return rxjs_1.Observable.from(buffer);
        }
        else {
            return rxjs_1.Observable.never();
        }
    });
    var patch$ = rxjs_1.Observable.merge(descriptor$, fromMutation$)
        .mergeMap(function (descriptor) {
        return diffAndPatch(descriptor);
    })
        .publish().refCount();
    return patch$;
}
function makeQueryRenderedFilter(diffMap$, event$, runSA) {
    return function queryRenderedFilter(info) {
        var out$ = diffMap$.switchMap(function (diffMap) {
            return event$.map(function (e) {
                var layers = info && info.layers && info.layers.filter(function (x) { return diffMap.getLayer(x); });
                if (layers) {
                    var features = diffMap.queryRenderedFeatures(e.point, { layers: layers });
                    return features;
                }
                return undefined;
            })
                .publish().refCount();
        });
        var observable = runSA ? runSA.adapt(out$, rxjs_adapter_1.default.streamSubscribe) : out$;
        return observable;
    };
}
function makeEventsSelector(diffMap$, runSA) {
    return function events(eventName) {
        if (typeof eventName !== "string") {
            throw new Error("MapboxGL driver's events() expects argument to be a " +
                "string representing the event type to listen for.");
        }
        var out$ = diffMap$.switchMap(function (diffMap) {
            return fromEvent(diffMap, eventName);
        })
            .publish().refCount();
        var observable = runSA ? runSA.adapt(out$, rxjs_adapter_1.default.streamSubscribe) : out$;
        return {
            observable: observable,
            queryRenderedFilter: makeQueryRenderedFilter(diffMap$, out$, runSA)
        };
    };
}
function makeMapSelector(applied$, runSA) {
    return function select(anchorId) {
        //console.log(`choosing map: ${anchorId}`)
        var diffMap$ = applied$
            .map(function () { return document.getElementById(anchorId); })
            .filter(function (x) { return !!x; })
            .distinctUntilChanged(function (x) { return x && x.diffMap; })
            .map(function (x) { return x.diffMap; })
            .publishReplay(1).refCount();
        return {
            observable: runSA ? runSA.adapt(diffMap$, rxjs_adapter_1.default.streamSubscribe) : diffMap$,
            events: makeEventsSelector(diffMap$, runSA)
        };
    };
}
function makeMapJSONDriver(accessToken) {
    if (!accessToken || (typeof (accessToken) !== 'string'))
        throw new Error("MapDOMDriver requires an access token.");
    if (!mapboxgl.accessToken) {
        mapboxgl.accessToken = accessToken;
    }
    function mapJSONDriver(descriptor$, runSA) {
        var adapted$;
        if (runSA) {
            adapted$ = rxjs_adapter_1.default.adapt(descriptor$, runSA.streamSubscribe)
                .publishReplay(1).refCount();
        }
        else {
            adapted$ = descriptor$
                .publishReplay(1).refCount();
        }
        var applied$ = renderRawRootElem$(adapted$, accessToken);
        applied$.subscribe();
        return {
            select: makeMapSelector(applied$, runSA)
        };
    }
    ;
    mapJSONDriver.streamAdapter = rxjs_adapter_1.default;
    return mapJSONDriver;
}
exports.makeMapJSONDriver = makeMapJSONDriver;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFpbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9tYWluLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSw2QkFBb0M7QUFDcEMsNkNBQThDO0FBQzlDLG9EQUF3QztBQUV4QyxJQUFNLGtCQUFrQixHQUFHLEVBQUUsQ0FBQTtBQUU3QixtQkFBbUIsT0FBTyxFQUFFLFNBQVM7SUFDbkMsTUFBTSxDQUFDLGlCQUFDLENBQUMsTUFBTSxDQUFDLFVBQUEsUUFBUTtRQUN0QixJQUFNLE9BQU8sR0FBRyxVQUFBLENBQUMsSUFBSSxPQUFBLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQWhCLENBQWdCLENBQUE7UUFDckMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxTQUFTLEVBQUUsT0FBTyxDQUFDLENBQUE7UUFDOUIsTUFBTSxDQUFDLGNBQU0sT0FBQSxPQUFPLENBQUMsR0FBRyxDQUFDLFNBQVMsRUFBRSxPQUFPLENBQUMsRUFBL0IsQ0FBK0IsQ0FBQTtJQUM5QyxDQUFDLENBQUMsQ0FBQTtBQUNKLENBQUM7QUFFRCxjQUFjLFFBQVEsRUFBRSxPQUFPO0lBQzdCLE1BQU0sQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxPQUFPLENBQUMsQ0FBQTtBQUM5QyxDQUFDO0FBRUQsZUFBZSxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsVUFBVTtJQUNwRCxJQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsa0JBQWtCLEVBQUUsVUFBVSxDQUFDLENBQUE7SUFDbEQsOENBQThDO0lBQzlDLHFDQUFxQztJQUNyQyw4QkFBOEI7SUFDOUIsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztRQUNILElBQUEseUJBQVEsRUFBRSxlQUFHLEVBQUUsdUJBQU8sRUFBRSxxQkFBTSxFQUFFLHFCQUFNLEVBQUUsdUJBQU8sQ0FBUztRQUMvRCxFQUFFLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO1lBQ2IsYUFBYSxDQUFDLE9BQU8sRUFBRSxRQUFRLEVBQUUsVUFBVSxDQUFDLFFBQVEsQ0FBQyxDQUFBO1FBQ3ZELENBQUM7UUFFRCxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQ1IsUUFBUSxDQUFDLE9BQU8sRUFBRSxHQUFHLEVBQUUsVUFBVSxDQUFDLEdBQUcsRUFBRSxPQUFPLENBQUMsQ0FBQTtRQUNqRCxDQUFDO1FBRUQsRUFBRSxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztZQUNaLFlBQVksQ0FBQyxPQUFPLEVBQUUsT0FBTyxFQUFFLFVBQVUsQ0FBQyxPQUFPLENBQUMsQ0FBQTtRQUNwRCxDQUFDO1FBRUQsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztZQUNYLFdBQVcsQ0FBQyxPQUFPLEVBQUUsTUFBTSxFQUFFLFVBQVUsQ0FBQyxNQUFNLENBQUMsQ0FBQTtRQUNqRCxDQUFDO1FBRUQsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztZQUNYLFdBQVcsQ0FBQyxPQUFPLEVBQUUsTUFBTSxFQUFFLFVBQVUsQ0FBQyxNQUFNLENBQUMsQ0FBQTtRQUNqRCxDQUFDO0lBQ0gsQ0FBQztJQUVELE1BQU0sQ0FBQyxVQUFVLENBQUE7QUFDbkIsQ0FBQztBQUVELGtCQUFrQixPQUFPLEVBQUUsUUFBUSxFQUFFLGFBQWEsRUFBRSxPQUFPO0lBQ3pELEVBQUUsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1FBQ2xCLE9BQU8sQ0FBQyxNQUFNLENBQUM7WUFDYixNQUFNLEVBQUUsT0FBTyxDQUFDLFNBQVMsRUFBRTtZQUMzQixJQUFJLEVBQUUsYUFBYSxDQUFDLElBQUk7U0FDekIsQ0FBQyxDQUFBO0lBQ0osQ0FBQztJQUVELEVBQUUsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO1FBQ3BCLElBQUksU0FBUyxHQUFHLGFBQWEsQ0FBQyxNQUFNLENBQUE7UUFDcEMsRUFBRSxDQUFDLENBQUMsT0FBTyxJQUFJLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO1lBQ3hCLElBQUEsbUJBQXVCLEVBQXRCLFNBQUMsRUFBRSxTQUFDLENBQWtCO1lBQzdCLElBQU0sV0FBVyxHQUFHLE9BQU8sQ0FBQyxPQUFPLENBQUMsYUFBYSxDQUFDLE1BQU0sQ0FBQyxDQUFBO1lBQ3pELElBQU0sYUFBYSxHQUFHLFdBQVcsQ0FBQyxHQUFHLENBQUMsRUFBQyxDQUFDLEdBQUEsRUFBRSxDQUFDLEdBQUEsRUFBQyxDQUFDLENBQUE7WUFDN0MsU0FBUyxHQUFHLE9BQU8sQ0FBQyxTQUFTLENBQUMsYUFBYSxDQUFDLENBQUE7UUFDOUMsQ0FBQztRQUVELE9BQU8sQ0FBQyxNQUFNLENBQUM7WUFDYixNQUFNLEVBQUUsU0FBUztZQUNqQixJQUFJLEVBQUUsT0FBTyxDQUFDLE9BQU8sRUFBRTtTQUN4QixDQUFDLENBQUE7SUFDSixDQUFDO0lBR0QsRUFBRSxDQUFDLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7UUFDckIsK0NBQStDO1FBQy9DLEVBQUUsQ0FBQSxDQUFDLGFBQWEsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO1lBQ3pCLDhCQUE4QjtZQUM5QixPQUFPLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFBRSxDQUFBO1FBQzFCLENBQUM7UUFBQyxJQUFJLENBQUMsQ0FBQztZQUNOLCtCQUErQjtZQUMvQixPQUFPLENBQUMsT0FBTyxDQUFDLE9BQU8sRUFBRSxDQUFBO1FBQzNCLENBQUM7SUFDSCxDQUFDO0FBQ0gsQ0FBQztBQUVELHNCQUFzQixPQUFPLEVBQUUsS0FBSyxFQUFFLFVBQVU7SUFDOUMsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztRQUNWLEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3pCLElBQU0sR0FBRyxHQUFHLEtBQUssQ0FBQyxNQUFNLENBQUE7WUFDeEIsSUFBSSxJQUFJLFNBQUEsQ0FBQTtZQUNSLE1BQU0sQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7Z0JBQ1osS0FBSyxDQUFDO29CQUNKLElBQUksR0FBRyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUE7b0JBQ2YsR0FBRyxDQUFDLENBQUMsSUFBSSxHQUFHLElBQUksSUFBSSxDQUFDLENBQUMsQ0FBQzt3QkFDckIsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7NEJBQzdCLElBQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQTs0QkFDdEIsT0FBTyxDQUFDLFNBQVMsQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLENBQUE7d0JBQzlCLENBQUM7b0JBQ0gsQ0FBQztvQkFDRCxLQUFLLENBQUE7Z0JBQ1AsS0FBSyxDQUFDO29CQUNKLElBQUksR0FBRyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUE7b0JBQ2YsR0FBRyxDQUFDLENBQUMsSUFBSSxHQUFHLElBQUksSUFBSSxDQUFDLENBQUMsQ0FBQzt3QkFDckIsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7NEJBQzdCLE9BQU8sQ0FBQyxZQUFZLENBQUMsR0FBRyxDQUFDLENBQUE7NEJBQ3pCLE9BQU8sQ0FBQyxTQUFTLENBQUMsR0FBRyxFQUFFLFVBQVUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFBO3dCQUN6QyxDQUFDO29CQUNILENBQUM7b0JBQ0QsS0FBSyxDQUFBO2dCQUNQLEtBQUssQ0FBQztvQkFDSixJQUFJLEdBQUcsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFBO29CQUNmLEdBQUcsQ0FBQyxDQUFDLElBQUksR0FBRyxJQUFJLElBQUksQ0FBQyxDQUFDLENBQUM7d0JBQ3JCLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDOzRCQUM3QixPQUFPLENBQUMsWUFBWSxDQUFDLEdBQUcsQ0FBQyxDQUFBO3dCQUMzQixDQUFDO29CQUNILENBQUM7b0JBQ0QsS0FBSyxDQUFBO2dCQUNQO29CQUNFLE1BQU0sSUFBSSxLQUFLLENBQUMsc0JBQXNCLENBQUMsQ0FBQTtZQUMzQyxDQUFDO1FBQ0gsQ0FBQztRQUFDLElBQUksQ0FBQyxDQUFDO1lBQ04sR0FBRyxDQUFDLENBQUMsSUFBSSxHQUFHLElBQUksS0FBSyxDQUFDLENBQUMsQ0FBQztnQkFDdEIsSUFBTSxPQUFPLEdBQUcsVUFBVSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQTtnQkFDcEMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUE7WUFDekMsQ0FBQztRQUNILENBQUM7SUFDSCxDQUFDO0FBQ0gsQ0FBQztBQUVELHFCQUFxQixPQUFPLEVBQUUsS0FBSyxFQUFFLFVBQVU7SUFDN0MsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztRQUNWLEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3pCLElBQU0sR0FBRyxHQUFHLEtBQUssQ0FBQyxNQUFNLENBQUE7WUFDeEIsSUFBSSxJQUFJLFNBQUEsQ0FBQTtZQUNSLE1BQU0sQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7Z0JBQ1osS0FBSyxDQUFDO29CQUNKLElBQUksR0FBRyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUE7b0JBQ2YsR0FBRyxDQUFDLENBQUMsSUFBSSxHQUFHLElBQUksSUFBSSxDQUFDLENBQUMsQ0FBQzt3QkFDckIsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7NEJBQzdCLElBQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQTs0QkFDdEIsT0FBTyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQTt3QkFDeEIsQ0FBQztvQkFDSCxDQUFDO29CQUNELEtBQUssQ0FBQTtnQkFDUCxLQUFLLENBQUM7b0JBQ0osSUFBSSxHQUFHLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQTtvQkFDZixHQUFHLENBQUMsQ0FBQyxJQUFJLEdBQUcsSUFBSSxJQUFJLENBQUMsQ0FBQyxDQUFDO3dCQUNyQixFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQzs0QkFDN0IsT0FBTyxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsQ0FBQTs0QkFDeEIsT0FBTyxDQUFDLFFBQVEsQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQTt3QkFDbkMsQ0FBQztvQkFDSCxDQUFDO29CQUNELEtBQUssQ0FBQTtnQkFDUCxLQUFLLENBQUM7b0JBQ0osSUFBSSxHQUFHLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQTtvQkFDZixHQUFHLENBQUMsQ0FBQyxJQUFJLEdBQUcsSUFBSSxJQUFJLENBQUMsQ0FBQyxDQUFDO3dCQUNyQixFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQzs0QkFDN0IsT0FBTyxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsQ0FBQTt3QkFDMUIsQ0FBQztvQkFDSCxDQUFDO29CQUNELEtBQUssQ0FBQTtnQkFDUDtvQkFDRSxNQUFNLElBQUksS0FBSyxDQUFDLHNCQUFzQixDQUFDLENBQUE7WUFDM0MsQ0FBQztRQUNILENBQUM7SUFPSCxDQUFDO0FBQ0gsQ0FBQztBQUVELHVCQUF1QixPQUFPLEVBQUUsS0FBSyxFQUFFLFVBQVU7QUFFakQsQ0FBQztBQUVELHFCQUFxQixPQUFPLEVBQUUsS0FBSyxFQUFFLFVBQVU7SUFDN0MsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztRQUNWLEVBQUUsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxLQUFLLElBQUksVUFBVSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO1lBQ2hELE9BQU8sQ0FBQyxTQUFTLEVBQUUsQ0FBQyxLQUFLLENBQUMsTUFBTSxHQUFHLFVBQVUsQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFBO1FBQzVELENBQUM7SUFDSCxDQUFDO0FBQ0gsQ0FBQztBQUdELHNCQUFzQixVQUFVO0lBQzlCLEVBQUUsQ0FBQyxDQUFDLE9BQU8sVUFBVSxLQUFLLFdBQVcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUM7UUFBQyxNQUFNLENBQUMsU0FBUyxDQUFBO0lBQUMsQ0FBQztJQUUxRSxJQUFNLFFBQVEsR0FBRyxVQUFVLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQTtJQUN6QyxJQUFNLE1BQU0sR0FBRyxRQUFRLENBQUMsY0FBYyxDQUFDLFFBQVEsQ0FBQyxDQUFBO0lBRWhELEVBQUUsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztRQUNaLGtCQUFrQixDQUFDLFFBQVEsQ0FBQyxHQUFHLFVBQVUsQ0FBQTtRQUN6QyxNQUFNLENBQUMsaUJBQUMsQ0FBQyxLQUFLLEVBQUUsQ0FBQTtJQUNsQixDQUFDO0lBQUMsSUFBSSxDQUFDLENBQUM7UUFDTixJQUFJLFNBQU8sR0FBVSxNQUFPLENBQUMsT0FBTyxDQUFBO1FBQ3BDLEVBQUUsQ0FBQyxDQUFDLENBQUMsU0FBTyxDQUFDLENBQUMsQ0FBQztZQUNOLElBQUEsZ0NBQVEsRUFBRSxvQkFBRyxFQUFFLDhCQUFPLEVBQUUsNEJBQU0sRUFBRSw0QkFBTSxFQUFFLDhCQUFPLENBQWM7WUFDcEUsU0FBTyxHQUFHLElBQUksUUFBUSxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLENBQUE7WUFFMUMsTUFBTSxDQUFDLGlCQUFDLENBQUMsTUFBTSxDQUFDLFVBQUEsUUFBUTtnQkFDdEIsU0FBTyxDQUFDLEVBQUUsQ0FBQyxNQUFNLEVBQUU7b0JBQ2pCLG9EQUFvRDtvQkFDcEQsU0FBTyxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUUsQ0FBQTtvQkFDekIsU0FBTyxDQUFDLE9BQU8sQ0FBQyxNQUFNLEVBQUUsQ0FBQTtvQkFDeEIsZ0JBQWdCO29CQUVoQixFQUFFLENBQUMsQ0FBQyxVQUFRLENBQUMsQ0FBQyxDQUFDO29CQUVmLENBQUM7b0JBRUQsRUFBRSxDQUFDLENBQUMsU0FBTyxDQUFDLENBQUMsQ0FBQzt3QkFDWixHQUFHLENBQUMsQ0FBQyxJQUFJLEdBQUcsSUFBSSxTQUFPLENBQUMsQ0FBQyxDQUFDOzRCQUN4QixFQUFFLENBQUMsQ0FBQyxTQUFPLENBQUMsY0FBYyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQ0FDaEMsU0FBTyxDQUFDLFNBQVMsQ0FBQyxHQUFHLEVBQUUsU0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUE7NEJBQ3RDLENBQUM7d0JBQ0gsQ0FBQztvQkFDSCxDQUFDO29CQUVELEVBQUUsQ0FBQyxDQUFDLFFBQU0sQ0FBQyxDQUFDLENBQUM7d0JBQ1gsR0FBRyxDQUFDLENBQUMsSUFBSSxHQUFHLElBQUksUUFBTSxDQUFDLENBQUMsQ0FBQzs0QkFDdkIsRUFBRSxDQUFDLENBQUMsUUFBTSxDQUFDLGNBQWMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0NBQy9CLFNBQU8sQ0FBQyxRQUFRLENBQUMsUUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUE7NEJBQy9CLENBQUM7d0JBQ0gsQ0FBQztvQkFDSCxDQUFDO29CQUVELEVBQUUsQ0FBQyxDQUFDLFFBQU0sQ0FBQyxDQUFDLENBQUM7d0JBQ1gsRUFBRSxDQUFDLENBQUMsUUFBTSxDQUFDLEtBQUssSUFBSSxRQUFNLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7NEJBQ3hDLFNBQU8sQ0FBQyxTQUFTLEVBQUUsQ0FBQyxLQUFLLENBQUMsTUFBTSxHQUFHLFFBQU0sQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFBO3dCQUN4RCxDQUFDO29CQUNILENBQUM7b0JBRUQsRUFBRSxDQUFDLENBQUMsU0FBTyxJQUFJLFNBQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO3dCQUN4QixJQUFBLHFCQUF1QixFQUF0QixTQUFDLEVBQUUsU0FBQyxDQUFrQjt3QkFDN0IsSUFBTSxXQUFXLEdBQUcsU0FBTyxDQUFDLE9BQU8sQ0FBQyxTQUFPLENBQUMsU0FBUyxFQUFFLENBQUMsQ0FBQTt3QkFDeEQsSUFBTSxhQUFhLEdBQUcsV0FBVyxDQUFDLEdBQUcsQ0FBQyxFQUFDLENBQUMsR0FBQSxFQUFFLENBQUMsR0FBQSxFQUFDLENBQUMsQ0FBQTt3QkFDN0MsSUFBTSxTQUFTLEdBQUcsU0FBTyxDQUFDLFNBQVMsQ0FBQyxhQUFhLENBQUMsQ0FBQTt3QkFDbEQsU0FBTyxDQUFDLFNBQVMsQ0FBQyxTQUFTLENBQUMsQ0FBQTtvQkFDOUIsQ0FBQztvQkFHRCxDQUFDO29CQUFPLE1BQU8sQ0FBQyxPQUFPLEdBQUcsU0FBTyxDQUNoQztvQkFBTyxNQUFPLENBQUMsa0JBQWtCLEdBQUcsVUFBVSxDQUFBO29CQUMvQyxRQUFRLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFBO29CQUN6QixRQUFRLENBQUMsUUFBUSxFQUFFLENBQUE7Z0JBQ3JCLENBQUMsQ0FBQyxDQUFBO1lBQ0osQ0FBQyxDQUFDLENBQUE7UUFDSixDQUFDO1FBQUMsSUFBSSxDQUFDLENBQUM7WUFDTixJQUFJLFVBQVUsR0FBVSxNQUFPLENBQUMsaUJBQWlCLENBQUE7WUFDakQsRUFBRSxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDO2dCQUNoQixDQUFDO2dCQUFPLE1BQU8sQ0FBQyxpQkFBaUIsR0FBRyxJQUFJLENBQUE7Z0JBQ3hDLElBQU0sa0JBQWtCLEdBQVUsTUFBTyxDQUFDLGtCQUFrQixDQUFBO2dCQUM1RCxJQUFNLEdBQUcsR0FBRyxpQkFBQyxDQUFDLEVBQUUsQ0FBQyxLQUFLLENBQUMsU0FBTyxFQUFFLGtCQUFrQixFQUFFLFVBQVUsQ0FBQyxDQUFDLENBQy9EO2dCQUFPLE1BQU8sQ0FBQyxrQkFBa0IsR0FBRyxVQUFVLENBQzlDO2dCQUFPLE1BQU8sQ0FBQyxpQkFBaUIsR0FBRyxLQUFLLENBQUE7Z0JBRXpDLElBQU0sTUFBTSxHQUFVLE1BQU8sQ0FBQyxlQUFlLENBQUE7Z0JBQzdDLEVBQUUsQ0FBQyxDQUFDLE1BQU0sSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxJQUFJLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO29CQUNyRCxJQUFNLENBQUMsR0FBRyxNQUFNLENBQUMsS0FBSyxFQUFFLENBQUE7b0JBQ3hCLE1BQU0sQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLENBQUE7Z0JBQ3hCLENBQUM7Z0JBRUQsTUFBTSxDQUFDLEdBQUcsQ0FBQTtZQUNaLENBQUM7WUFBQyxJQUFJLENBQUMsQ0FBQztnQkFDTixJQUFNLE1BQU0sR0FBVSxNQUFPLENBQUMsZUFBZSxDQUFBO2dCQUM3QyxFQUFFLENBQUMsQ0FBQyxNQUFNLElBQUksS0FBSyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUM7b0JBQ3BDLE1BQU0sQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUE7Z0JBQ3pCLENBQUM7Z0JBQUMsSUFBSSxDQUFDLENBQUM7b0JBQ04sQ0FBQztvQkFBTyxNQUFPLENBQUMsZUFBZSxHQUFHLENBQUMsVUFBVSxDQUFDLENBQUE7Z0JBQ2hELENBQUM7Z0JBRUQsTUFBTSxDQUFDLGlCQUFDLENBQUMsS0FBSyxFQUFFLENBQUE7WUFDbEIsQ0FBQztRQUNILENBQUM7SUFDSCxDQUFDO0FBQ0gsQ0FBQztBQUVELDRCQUE0QixXQUFXLEVBQUUsV0FBVztJQUVsRCxJQUFNLFNBQVMsR0FBRyxpQkFBQyxDQUFDLE1BQU0sQ0FBQyxVQUFBLFFBQVE7UUFDakMsSUFBTSxTQUFTLEdBQUcsSUFBSSxnQkFBZ0IsQ0FBQyxVQUFBLENBQUMsSUFBSSxPQUFBLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQWhCLENBQWdCLENBQUMsQ0FBQTtRQUM3RCxJQUFNLE1BQU0sR0FBRyxFQUFFLFNBQVMsRUFBRSxJQUFJLEVBQUUsT0FBTyxFQUFFLElBQUksRUFBRSxDQUFDO1FBQ2xELFNBQVMsQ0FBQyxPQUFPLENBQUMsUUFBUSxFQUFFLE1BQU0sQ0FBQyxDQUFDO1FBQ3BDLE1BQU0sQ0FBQyxjQUFRLFNBQVMsQ0FBQyxVQUFVLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQTtJQUMxQyxDQUFDLENBQUMsQ0FBQTtJQUVGLElBQU0sYUFBYSxHQUFHLFNBQVM7U0FDNUIsU0FBUyxDQUFDO1FBQ1QsSUFBSSxRQUFRLENBQUE7UUFDWixJQUFNLE1BQU0sR0FBRyxFQUFFLENBQUE7UUFDakIsR0FBRyxDQUFDLENBQUMsUUFBUSxJQUFJLGtCQUFrQixDQUFDLENBQUMsQ0FBQztZQUNwQyxJQUFNLE1BQU0sR0FBRyxRQUFRLENBQUMsY0FBYyxDQUFDLFFBQVEsQ0FBQyxDQUFBO1lBQ2hELEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7Z0JBQ1gsSUFBTSxnQkFBZ0IsR0FBRyxrQkFBa0IsQ0FBQyxRQUFRLENBQUMsQ0FBQTtnQkFDckQsT0FBTyxrQkFBa0IsQ0FBQyxRQUFRLENBQUMsQ0FBQTtnQkFDbkMsTUFBTSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFBO1lBQy9CLENBQUM7UUFDSCxDQUFDO1FBRUQsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7WUFDbEIsTUFBTSxDQUFDLGlCQUFDLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFBO1FBQ3ZCLENBQUM7UUFBQyxJQUFJLENBQUMsQ0FBQztZQUNOLE1BQU0sQ0FBQyxpQkFBQyxDQUFDLEtBQUssRUFBRSxDQUFBO1FBQ2xCLENBQUM7SUFDSCxDQUFDLENBQUMsQ0FBQTtJQUVKLElBQU0sTUFBTSxHQUFHLGlCQUFDLENBQUMsS0FBSyxDQUFDLFdBQVcsRUFBRSxhQUFhLENBQUM7U0FDL0MsUUFBUSxDQUFDLFVBQUEsVUFBVTtRQUNsQixNQUFNLENBQUMsWUFBWSxDQUFDLFVBQVUsQ0FBQyxDQUFBO0lBQ2pDLENBQUMsQ0FBQztTQUNELE9BQU8sRUFBRSxDQUFDLFFBQVEsRUFBRSxDQUFBO0lBRXZCLE1BQU0sQ0FBQyxNQUFNLENBQUE7QUFDZixDQUFDO0FBRUQsaUNBQWlDLFFBQVEsRUFBRSxNQUFNLEVBQUUsS0FBSztJQUN0RCxNQUFNLENBQUMsNkJBQTZCLElBQUk7UUFDdEMsSUFBTSxJQUFJLEdBQUcsUUFBUSxDQUFDLFNBQVMsQ0FBQyxVQUFBLE9BQU87WUFDckMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsVUFBQSxDQUFDO2dCQUNqQixJQUFNLE1BQU0sR0FBRyxJQUFJLElBQUksSUFBSSxDQUFDLE1BQU0sSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxVQUFBLENBQUMsSUFBSSxPQUFBLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLEVBQW5CLENBQW1CLENBQUMsQ0FBQTtnQkFDbEYsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztvQkFDWCxJQUFNLFFBQVEsR0FBRyxPQUFPLENBQUMscUJBQXFCLENBQUMsQ0FBQyxDQUFDLEtBQUssRUFBRSxFQUFDLE1BQU0sUUFBQSxFQUFDLENBQUMsQ0FBQTtvQkFDakUsTUFBTSxDQUFDLFFBQVEsQ0FBQTtnQkFDakIsQ0FBQztnQkFFRCxNQUFNLENBQUMsU0FBUyxDQUFBO1lBQ2xCLENBQUMsQ0FBQztpQkFFRCxPQUFPLEVBQUUsQ0FBQyxRQUFRLEVBQUUsQ0FBQTtRQUN2QixDQUFDLENBQUMsQ0FBQTtRQUVGLElBQU0sVUFBVSxHQUFHLEtBQUssR0FBRyxLQUFLLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxzQkFBTSxDQUFDLGVBQWUsQ0FBQyxHQUFHLElBQUksQ0FBQTtRQUMzRSxNQUFNLENBQUMsVUFBVSxDQUFBO0lBQ25CLENBQUMsQ0FBQTtBQUNILENBQUM7QUFFRCw0QkFBNEIsUUFBUSxFQUFFLEtBQUs7SUFDekMsTUFBTSxDQUFDLGdCQUFnQixTQUFTO1FBQzlCLEVBQUUsQ0FBQyxDQUFDLE9BQU8sU0FBUyxLQUFLLFFBQVEsQ0FBQyxDQUFDLENBQUM7WUFDbEMsTUFBTSxJQUFJLEtBQUssQ0FBQyxzREFBc0Q7Z0JBQ3BFLG1EQUFtRCxDQUFDLENBQUE7UUFDeEQsQ0FBQztRQUVELElBQU0sSUFBSSxHQUFHLFFBQVEsQ0FBQyxTQUFTLENBQUMsVUFBQSxPQUFPO1lBQ3JDLE1BQU0sQ0FBQyxTQUFTLENBQUMsT0FBTyxFQUFFLFNBQVMsQ0FBQyxDQUFBO1FBQ3RDLENBQUMsQ0FBQzthQUNELE9BQU8sRUFBRSxDQUFDLFFBQVEsRUFBRSxDQUFBO1FBRXJCLElBQU0sVUFBVSxHQUFHLEtBQUssR0FBRyxLQUFLLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxzQkFBTSxDQUFDLGVBQWUsQ0FBQyxHQUFHLElBQUksQ0FBQTtRQUMzRSxNQUFNLENBQUM7WUFDTCxVQUFVLFlBQUE7WUFDVixtQkFBbUIsRUFBRSx1QkFBdUIsQ0FBQyxRQUFRLEVBQUUsSUFBSSxFQUFFLEtBQUssQ0FBQztTQUNwRSxDQUFBO0lBQ0gsQ0FBQyxDQUFBO0FBQ0gsQ0FBQztBQUVELHlCQUF5QixRQUFRLEVBQUUsS0FBSztJQUN0QyxNQUFNLENBQUMsZ0JBQWdCLFFBQVE7UUFDN0IsMENBQTBDO1FBQzFDLElBQU0sUUFBUSxHQUFHLFFBQVE7YUFDdEIsR0FBRyxDQUFDLGNBQU0sT0FBQSxRQUFRLENBQUMsY0FBYyxDQUFDLFFBQVEsQ0FBQyxFQUFqQyxDQUFpQyxDQUFDO2FBQzVDLE1BQU0sQ0FBQyxVQUFBLENBQUMsSUFBSSxPQUFBLENBQUMsQ0FBQyxDQUFDLEVBQUgsQ0FBRyxDQUFDO2FBQ2hCLG9CQUFvQixDQUNuQixVQUFBLENBQUMsSUFBSSxPQUFBLENBQUMsSUFBVyxDQUFFLENBQUMsT0FBTyxFQUF0QixDQUFzQixDQUM1QjthQUNBLEdBQUcsQ0FBQyxVQUFBLENBQUMsSUFBSSxPQUFBLENBQUMsQ0FBQyxPQUFPLEVBQVQsQ0FBUyxDQUFDO2FBQ25CLGFBQWEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxRQUFRLEVBQUUsQ0FBQTtRQUU5QixNQUFNLENBQUM7WUFDTCxVQUFVLEVBQUUsS0FBSyxHQUFHLEtBQUssQ0FBQyxLQUFLLENBQUMsUUFBUSxFQUFFLHNCQUFNLENBQUMsZUFBZSxDQUFDLEdBQUcsUUFBUTtZQUM1RSxNQUFNLEVBQUUsa0JBQWtCLENBQUMsUUFBUSxFQUFFLEtBQUssQ0FBQztTQUM1QyxDQUFBO0lBQ0gsQ0FBQyxDQUFBO0FBQ0gsQ0FBQztBQUVELDJCQUFrQyxXQUFtQjtJQUNuRCxFQUFFLENBQUMsQ0FBQyxDQUFDLFdBQVcsSUFBSSxDQUFDLE9BQU0sQ0FBQyxXQUFXLENBQUMsS0FBSyxRQUFRLENBQUMsQ0FBQztRQUFDLE1BQU0sSUFBSSxLQUFLLENBQUMsd0NBQXdDLENBQUMsQ0FBQTtJQUVqSCxFQUFFLENBQUEsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDO1FBQ3pCLFFBQVEsQ0FBQyxXQUFXLEdBQUcsV0FBVyxDQUFBO0lBQ3BDLENBQUM7SUFFRCx1QkFBdUIsV0FBVyxFQUFFLEtBQUs7UUFFdkMsSUFBSSxRQUFRLENBQUE7UUFDWixFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO1lBQ1YsUUFBUSxHQUFHLHNCQUFNLENBQUMsS0FBSyxDQUFDLFdBQVcsRUFBRSxLQUFLLENBQUMsZUFBZSxDQUFDO2lCQUN4RCxhQUFhLENBQUMsQ0FBQyxDQUFDLENBQUMsUUFBUSxFQUFFLENBQUE7UUFDaEMsQ0FBQztRQUFDLElBQUksQ0FBQyxDQUFDO1lBQ04sUUFBUSxHQUFHLFdBQVc7aUJBQ25CLGFBQWEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxRQUFRLEVBQUUsQ0FBQTtRQUNoQyxDQUFDO1FBRUQsSUFBTyxRQUFRLEdBQUcsa0JBQWtCLENBQUMsUUFBUSxFQUFFLFdBQVcsQ0FBQyxDQUFBO1FBRzNELFFBQVEsQ0FBQyxTQUFTLEVBQUUsQ0FBQTtRQUVwQixNQUFNLENBQUM7WUFDTCxNQUFNLEVBQUUsZUFBZSxDQUFDLFFBQVEsRUFBRSxLQUFLLENBQUM7U0FDekMsQ0FBQTtJQUNILENBQUM7SUFFRCxDQUFDO0lBQU8sYUFBYyxDQUFDLGFBQWEsR0FBRyxzQkFBTSxDQUFBO0lBQzdDLE1BQU0sQ0FBQyxhQUFhLENBQUE7QUFDdEIsQ0FBQztBQTlCRCw4Q0E4QkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge09ic2VydmFibGUgYXMgT30gZnJvbSAncnhqcydcbmltcG9ydCAqIGFzIGpzb25kaWZmcGF0Y2ggZnJvbSAnanNvbmRpZmZwYXRjaCdcbmltcG9ydCByeGpzU0EgZnJvbSAnQGN5Y2xlL3J4anMtYWRhcHRlcidcblxuY29uc3QgZ191bmFuY2hvcmVkTGVkZ2VyID0ge31cblxuZnVuY3Rpb24gZnJvbUV2ZW50KGRpZmZNYXAsIGV2ZW50TmFtZSkge1xuICByZXR1cm4gTy5jcmVhdGUob2JzZXJ2ZXIgPT4ge1xuICAgIGNvbnN0IGhhbmRsZXIgPSBlID0+IG9ic2VydmVyLm5leHQoZSlcbiAgICBkaWZmTWFwLm9uKGV2ZW50TmFtZSwgaGFuZGxlcilcbiAgICByZXR1cm4gKCkgPT4gZGlmZk1hcC5vZmYoZXZlbnROYW1lLCBoYW5kbGVyKVxuICB9KVxufVxuXG5mdW5jdGlvbiBkaWZmKHByZXZpb3VzLCBjdXJyZW50KSB7XG4gIHJldHVybiBqc29uZGlmZnBhdGNoLmRpZmYocHJldmlvdXMsIGN1cnJlbnQpXG59XG5cbmZ1bmN0aW9uIHBhdGNoKGRpZmZNYXAsIHByZXZpb3VzRGVzY3JpcHRvciwgZGVzY3JpcHRvcikge1xuICBjb25zdCBkZWx0YSA9IGRpZmYocHJldmlvdXNEZXNjcmlwdG9yLCBkZXNjcmlwdG9yKVxuICAvLyBjb25zb2xlLmxvZyhgcHJldmlvdXNgLCBwcmV2aW91c0Rlc2NyaXB0b3IpXG4gIC8vIGNvbnNvbGUubG9nKGBjdXJyZW50YCwgZGVzY3JpcHRvcilcbiAgLy8gY29uc29sZS5sb2coYGRlbHRhYCwgZGVsdGEpXG4gIGlmIChkZWx0YSkge1xuICAgIGNvbnN0IHtjb250cm9scywgbWFwLCBzb3VyY2VzLCBsYXllcnMsIGNhbnZhcywgb3B0aW9uc30gPSBkZWx0YVxuICAgIGlmIChjb250cm9scykge1xuICAgICAgcGF0Y2hDb250cm9scyhkaWZmTWFwLCBjb250cm9scywgZGVzY3JpcHRvci5jb250cm9scylcbiAgICB9XG5cbiAgICBpZiAobWFwKSB7XG4gICAgICBwYXRjaE1hcChkaWZmTWFwLCBtYXAsIGRlc2NyaXB0b3IubWFwLCBvcHRpb25zKVxuICAgIH1cblxuICAgIGlmIChzb3VyY2VzKSB7XG4gICAgICBwYXRjaFNvdXJjZXMoZGlmZk1hcCwgc291cmNlcywgZGVzY3JpcHRvci5zb3VyY2VzKVxuICAgIH1cblxuICAgIGlmIChsYXllcnMpIHtcbiAgICAgIHBhdGNoTGF5ZXJzKGRpZmZNYXAsIGxheWVycywgZGVzY3JpcHRvci5sYXllcnMpXG4gICAgfVxuXG4gICAgaWYgKGNhbnZhcykge1xuICAgICAgcGF0Y2hDYW52YXMoZGlmZk1hcCwgY2FudmFzLCBkZXNjcmlwdG9yLmNhbnZhcylcbiAgICB9XG4gIH1cblxuICByZXR1cm4gZGVzY3JpcHRvclxufVxuXG5mdW5jdGlvbiBwYXRjaE1hcChkaWZmTWFwLCBtYXBEZWx0YSwgbWFwRGVzY3JpcHRvciwgb3B0aW9ucykge1xuICBpZiAobWFwRGVsdGEuem9vbSkge1xuICAgIGRpZmZNYXAuZWFzZVRvKHtcbiAgICAgIGNlbnRlcjogZGlmZk1hcC5nZXRDZW50ZXIoKSxcbiAgICAgIHpvb206IG1hcERlc2NyaXB0b3Iuem9vbVxuICAgIH0pXG4gIH1cblxuICBpZiAobWFwRGVsdGEuY2VudGVyKSB7XG4gICAgbGV0IG5ld0NlbnRlciA9IG1hcERlc2NyaXB0b3IuY2VudGVyXG4gICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5vZmZzZXQpIHtcbiAgICAgIGNvbnN0IFt4LCB5XSA9IG9wdGlvbnMub2Zmc2V0XG4gICAgICBjb25zdCBjb29yZGluYXRlcyA9IGRpZmZNYXAucHJvamVjdChtYXBEZXNjcmlwdG9yLmNlbnRlcilcbiAgICAgIGNvbnN0IHNoaWZ0ZWRDZW50ZXIgPSBjb29yZGluYXRlcy5zdWIoe3gsIHl9KVxuICAgICAgbmV3Q2VudGVyID0gZGlmZk1hcC51bnByb2plY3Qoc2hpZnRlZENlbnRlcilcbiAgICB9XG4gICAgXG4gICAgZGlmZk1hcC5lYXNlVG8oe1xuICAgICAgY2VudGVyOiBuZXdDZW50ZXIsXG4gICAgICB6b29tOiBkaWZmTWFwLmdldFpvb20oKVxuICAgIH0pXG4gIH1cblxuXG4gIGlmIChtYXBEZWx0YS5kcmFnUGFuKSB7XG4gICAgLy9jb25zb2xlLmxvZyhgZHJhZ1BhbmAsIG1hcERlc2NyaXB0b3IuZHJhZ1BhbilcbiAgICBpZihtYXBEZXNjcmlwdG9yLmRyYWdQYW4pIHtcbiAgICAgIC8vY29uc29sZS5sb2coYGVuYWJsaW5nIGRyYWdgKVxuICAgICAgZGlmZk1hcC5kcmFnUGFuLmVuYWJsZSgpXG4gICAgfSBlbHNlIHtcbiAgICAgIC8vY29uc29sZS5sb2coYGRpc2FibGluZyBkcmFnYClcbiAgICAgIGRpZmZNYXAuZHJhZ1Bhbi5kaXNhYmxlKClcbiAgICB9XG4gIH1cbn1cblxuZnVuY3Rpb24gcGF0Y2hTb3VyY2VzKGRpZmZNYXAsIGRlbHRhLCBkZXNjcmlwdG9yKSB7XG4gIGlmIChkZWx0YSkge1xuICAgIGlmIChBcnJheS5pc0FycmF5KGRlbHRhKSkge1xuICAgICAgY29uc3QgbGVuID0gZGVsdGEubGVuZ3RoXG4gICAgICBsZXQgdmFsc1xuICAgICAgc3dpdGNoIChsZW4pIHtcbiAgICAgICAgY2FzZSAxOiAvLyBBZGRcbiAgICAgICAgICB2YWxzID0gZGVsdGFbMF1cbiAgICAgICAgICBmb3IgKGxldCBrZXkgaW4gdmFscykge1xuICAgICAgICAgICAgaWYgKHZhbHMuaGFzT3duUHJvcGVydHkoa2V5KSkge1xuICAgICAgICAgICAgICBjb25zdCBkYXRhID0gdmFsc1trZXldXG4gICAgICAgICAgICAgIGRpZmZNYXAuYWRkU291cmNlKGtleSwgZGF0YSlcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgICAgYnJlYWtcbiAgICAgICAgY2FzZSAyOiAvLyBNb2RpZnlcbiAgICAgICAgICB2YWxzID0gZGVsdGFbMF1cbiAgICAgICAgICBmb3IgKGxldCBrZXkgaW4gdmFscykge1xuICAgICAgICAgICAgaWYgKHZhbHMuaGFzT3duUHJvcGVydHkoa2V5KSkge1xuICAgICAgICAgICAgICBkaWZmTWFwLnJlbW92ZVNvdXJjZShrZXkpXG4gICAgICAgICAgICAgIGRpZmZNYXAuYWRkU291cmNlKGtleSwgZGVzY3JpcHRvcltrZXldKVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgICBicmVha1xuICAgICAgICBjYXNlIDM6IC8vIERlbGV0ZVxuICAgICAgICAgIHZhbHMgPSBkZWx0YVswXVxuICAgICAgICAgIGZvciAobGV0IGtleSBpbiB2YWxzKSB7XG4gICAgICAgICAgICBpZiAodmFscy5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7XG4gICAgICAgICAgICAgIGRpZmZNYXAucmVtb3ZlU291cmNlKGtleSlcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgICAgYnJlYWtcbiAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJJbnZhbGlkIGRlbHRhIGxlbmd0aFwiKVxuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBmb3IgKGxldCBrZXkgaW4gZGVsdGEpIHtcbiAgICAgICAgY29uc3QgbmV3RGF0YSA9IGRlc2NyaXB0b3Jba2V5XS5kYXRhXG4gICAgICAgIGRpZmZNYXAuZ2V0U291cmNlKGtleSkuc2V0RGF0YShuZXdEYXRhKVxuICAgICAgfVxuICAgIH1cbiAgfVxufVxuXG5mdW5jdGlvbiBwYXRjaExheWVycyhkaWZmTWFwLCBkZWx0YSwgZGVzY3JpcHRvcikge1xuICBpZiAoZGVsdGEpIHtcbiAgICBpZiAoQXJyYXkuaXNBcnJheShkZWx0YSkpIHtcbiAgICAgIGNvbnN0IGxlbiA9IGRlbHRhLmxlbmd0aFxuICAgICAgbGV0IHZhbHNcbiAgICAgIHN3aXRjaCAobGVuKSB7XG4gICAgICAgIGNhc2UgMTogLy8gQWRkXG4gICAgICAgICAgdmFscyA9IGRlbHRhWzBdXG4gICAgICAgICAgZm9yIChsZXQga2V5IGluIHZhbHMpIHtcbiAgICAgICAgICAgIGlmICh2YWxzLmhhc093blByb3BlcnR5KGtleSkpIHtcbiAgICAgICAgICAgICAgY29uc3QgZGF0YSA9IHZhbHNba2V5XVxuICAgICAgICAgICAgICBkaWZmTWFwLmFkZExheWVyKGRhdGEpXG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICAgIGJyZWFrXG4gICAgICAgIGNhc2UgMjogLy8gTW9kaWZ5XG4gICAgICAgICAgdmFscyA9IGRlbHRhWzBdXG4gICAgICAgICAgZm9yIChsZXQga2V5IGluIHZhbHMpIHtcbiAgICAgICAgICAgIGlmICh2YWxzLmhhc093blByb3BlcnR5KGtleSkpIHtcbiAgICAgICAgICAgICAgZGlmZk1hcC5yZW1vdmVMYXllcihrZXkpXG4gICAgICAgICAgICAgIGRpZmZNYXAuYWRkTGF5ZXIoZGVzY3JpcHRvcltrZXldKVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgICBicmVha1xuICAgICAgICBjYXNlIDM6IC8vIERlbGV0ZVxuICAgICAgICAgIHZhbHMgPSBkZWx0YVswXVxuICAgICAgICAgIGZvciAobGV0IGtleSBpbiB2YWxzKSB7XG4gICAgICAgICAgICBpZiAodmFscy5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7XG4gICAgICAgICAgICAgIGRpZmZNYXAucmVtb3ZlTGF5ZXIoa2V5KVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgICBicmVha1xuICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIkludmFsaWQgZGVsdGEgbGVuZ3RoXCIpXG4gICAgICB9XG4gICAgfSBcbiAgICAvLyBlbHNlIHtcbiAgICAvLyAgIC8vIGZvciAobGV0IGtleSBpbiBkZWx0YSkge1xuICAgIC8vICAgLy8gICBjb25zdCBuZXdEYXRhID0gZGVzY3JpcHRvcltrZXldLmRhdGFcbiAgICAvLyAgIC8vICAgZGlmZk1hcC5nZXRTb3VyY2Uoa2V5KS5zZXREYXRhKG5ld0RhdGEpXG4gICAgLy8gICAvLyB9XG4gICAgLy8gfVxuICB9XG59XG5cbmZ1bmN0aW9uIHBhdGNoQ29udHJvbHMoZGlmZk1hcCwgZGVsdGEsIGRlc2NyaXB0b3IpIHtcblxufVxuXG5mdW5jdGlvbiBwYXRjaENhbnZhcyhkaWZmTWFwLCBkZWx0YSwgZGVzY3JpcHRvcikge1xuICBpZiAoZGVsdGEpIHtcbiAgICBpZiAoZGVzY3JpcHRvci5zdHlsZSAmJiBkZXNjcmlwdG9yLnN0eWxlLmN1cnNvcikge1xuICAgICAgZGlmZk1hcC5nZXRDYW52YXMoKS5zdHlsZS5jdXJzb3IgPSBkZXNjcmlwdG9yLnN0eWxlLmN1cnNvclxuICAgIH1cbiAgfVxufVxuXG5cbmZ1bmN0aW9uIGRpZmZBbmRQYXRjaChkZXNjcmlwdG9yKSB7XG4gIGlmICh0eXBlb2YgZGVzY3JpcHRvciA9PT0gYHVuZGVmaW5lZGAgfHwgIWRlc2NyaXB0b3IpIHsgcmV0dXJuIHVuZGVmaW5lZCB9XG5cbiAgY29uc3QgYW5jaG9ySWQgPSBkZXNjcmlwdG9yLm1hcC5jb250YWluZXJcbiAgY29uc3QgYW5jaG9yID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoYW5jaG9ySWQpXG5cbiAgaWYgKCFhbmNob3IpIHtcbiAgICBnX3VuYW5jaG9yZWRMZWRnZXJbYW5jaG9ySWRdID0gZGVzY3JpcHRvclxuICAgIHJldHVybiBPLm5ldmVyKClcbiAgfSBlbHNlIHtcbiAgICBsZXQgZGlmZk1hcCA9ICg8YW55PiBhbmNob3IpLmRpZmZNYXBcbiAgICBpZiAoIWRpZmZNYXApIHtcbiAgICAgIGNvbnN0IHtjb250cm9scywgbWFwLCBzb3VyY2VzLCBsYXllcnMsIGNhbnZhcywgb3B0aW9uc30gPSBkZXNjcmlwdG9yXG4gICAgICBkaWZmTWFwID0gbmV3IG1hcGJveGdsLk1hcChkZXNjcmlwdG9yLm1hcClcbiAgICAgIFxuICAgICAgcmV0dXJuIE8uY3JlYXRlKG9ic2VydmVyID0+IHtcbiAgICAgICAgZGlmZk1hcC5vbignbG9hZCcsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAvKioqIEhBQ0sgdG8gYWxsb3cgZm9yIGVuYWJsZS9kaXNhYmxlIGZyb20gb3V0c2V0ICovXG4gICAgICAgICAgZGlmZk1hcC5kcmFnUGFuLmRpc2FibGUoKVxuICAgICAgICAgIGRpZmZNYXAuZHJhZ1Bhbi5lbmFibGUoKVxuICAgICAgICAgIC8qKiogRW5kIEhBQ0sgKi9cblxuICAgICAgICAgIGlmIChjb250cm9scykge1xuXG4gICAgICAgICAgfVxuXG4gICAgICAgICAgaWYgKHNvdXJjZXMpIHtcbiAgICAgICAgICAgIGZvciAobGV0IGtleSBpbiBzb3VyY2VzKSB7XG4gICAgICAgICAgICAgIGlmIChzb3VyY2VzLmhhc093blByb3BlcnR5KGtleSkpIHtcbiAgICAgICAgICAgICAgICBkaWZmTWFwLmFkZFNvdXJjZShrZXksIHNvdXJjZXNba2V5XSlcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cblxuICAgICAgICAgIGlmIChsYXllcnMpIHtcbiAgICAgICAgICAgIGZvciAobGV0IGtleSBpbiBsYXllcnMpIHtcbiAgICAgICAgICAgICAgaWYgKGxheWVycy5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7XG4gICAgICAgICAgICAgICAgZGlmZk1hcC5hZGRMYXllcihsYXllcnNba2V5XSlcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cblxuICAgICAgICAgIGlmIChjYW52YXMpIHtcbiAgICAgICAgICAgIGlmIChjYW52YXMuc3R5bGUgJiYgY2FudmFzLnN0eWxlLmN1cnNvcikge1xuICAgICAgICAgICAgICBkaWZmTWFwLmdldENhbnZhcygpLnN0eWxlLmN1cnNvciA9IGNhbnZhcy5zdHlsZS5jdXJzb3JcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG5cbiAgICAgICAgICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLm9mZnNldCkge1xuICAgICAgICAgICAgY29uc3QgW3gsIHldID0gb3B0aW9ucy5vZmZzZXRcbiAgICAgICAgICAgIGNvbnN0IGNvb3JkaW5hdGVzID0gZGlmZk1hcC5wcm9qZWN0KGRpZmZNYXAuZ2V0Q2VudGVyKCkpXG4gICAgICAgICAgICBjb25zdCBzaGlmdGVkQ2VudGVyID0gY29vcmRpbmF0ZXMuc3ViKHt4LCB5fSlcbiAgICAgICAgICAgIGNvbnN0IG5ld0NlbnRlciA9IGRpZmZNYXAudW5wcm9qZWN0KHNoaWZ0ZWRDZW50ZXIpXG4gICAgICAgICAgICBkaWZmTWFwLnNldENlbnRlcihuZXdDZW50ZXIpXG4gICAgICAgICAgfVxuXG5cbiAgICAgICAgICA7KDxhbnk+IGFuY2hvcikuZGlmZk1hcCA9IGRpZmZNYXBcbiAgICAgICAgICA7KDxhbnk+IGFuY2hvcikucHJldmlvdXNEZXNjcmlwdG9yID0gZGVzY3JpcHRvclxuICAgICAgICAgIG9ic2VydmVyLm5leHQoZGVzY3JpcHRvcilcbiAgICAgICAgICBvYnNlcnZlci5jb21wbGV0ZSgpXG4gICAgICAgIH0pXG4gICAgICB9KVxuICAgIH0gZWxzZSB7XG4gICAgICBsZXQgcHJvY2Vzc2luZyA9ICg8YW55PiBhbmNob3IpLmRpZmZNYXBQcm9jZXNzaW5nXG4gICAgICBpZiAoIXByb2Nlc3NpbmcpIHtcbiAgICAgICAgOyg8YW55PiBhbmNob3IpLmRpZmZNYXBQcm9jZXNzaW5nID0gdHJ1ZVxuICAgICAgICBjb25zdCBwcmV2aW91c0Rlc2NyaXB0b3IgPSAoPGFueT4gYW5jaG9yKS5wcmV2aW91c0Rlc2NyaXB0b3JcbiAgICAgICAgY29uc3Qgb3V0ID0gTy5vZihwYXRjaChkaWZmTWFwLCBwcmV2aW91c0Rlc2NyaXB0b3IsIGRlc2NyaXB0b3IpKVxuICAgICAgICA7KDxhbnk+IGFuY2hvcikucHJldmlvdXNEZXNjcmlwdG9yID0gZGVzY3JpcHRvclxuICAgICAgICA7KDxhbnk+IGFuY2hvcikuZGlmZk1hcFByb2Nlc3NpbmcgPSBmYWxzZVxuXG4gICAgICAgIGNvbnN0IHF1ZXVlZCA9ICg8YW55PiBhbmNob3IpLmRlc2NyaXB0b3JRdWV1ZVxuICAgICAgICBpZiAocXVldWVkICYmIEFycmF5LmlzQXJyYXkocXVldWVkKSAmJiBxdWV1ZWQubGVuZ3RoKSB7XG4gICAgICAgICAgY29uc3QgZCA9IHF1ZXVlZC5zaGlmdCgpXG4gICAgICAgICAgcmV0dXJuIGRpZmZBbmRQYXRjaChkKVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIG91dFxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc3QgcXVldWVkID0gKDxhbnk+IGFuY2hvcikuZGVzY3JpcHRvclF1ZXVlXG4gICAgICAgIGlmIChxdWV1ZWQgJiYgQXJyYXkuaXNBcnJheShxdWV1ZWQpKSB7XG4gICAgICAgICAgcXVldWVkLnB1c2goZGVzY3JpcHRvcilcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICA7KDxhbnk+IGFuY2hvcikuZGVzY3JpcHRvclF1ZXVlID0gW2Rlc2NyaXB0b3JdXG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gTy5uZXZlcigpXG4gICAgICB9XG4gICAgfVxuICB9XG59XG5cbmZ1bmN0aW9uIHJlbmRlclJhd1Jvb3RFbGVtJChkZXNjcmlwdG9yJCwgYWNjZXNzVG9rZW4pIHtcblxuICBjb25zdCBtdXRhdGlvbiQgPSBPLmNyZWF0ZShvYnNlcnZlciA9PiB7XG4gICAgY29uc3QgbU9ic2VydmVyID0gbmV3IE11dGF0aW9uT2JzZXJ2ZXIobSA9PiBvYnNlcnZlci5uZXh0KG0pKVxuICAgIGNvbnN0IGNvbmZpZyA9IHsgY2hpbGRMaXN0OiB0cnVlLCBzdWJ0cmVlOiB0cnVlIH07XG4gICAgbU9ic2VydmVyLm9ic2VydmUoZG9jdW1lbnQsIGNvbmZpZyk7XG4gICAgcmV0dXJuICgpID0+IHsgbU9ic2VydmVyLmRpc2Nvbm5lY3QoKTsgfVxuICB9KVxuXG4gIGNvbnN0IGZyb21NdXRhdGlvbiQgPSBtdXRhdGlvbiRcbiAgICAuc3dpdGNoTWFwKCgpID0+IHtcbiAgICAgIGxldCBhbmNob3JJZFxuICAgICAgY29uc3QgYnVmZmVyID0gW11cbiAgICAgIGZvciAoYW5jaG9ySWQgaW4gZ191bmFuY2hvcmVkTGVkZ2VyKSB7XG4gICAgICAgIGNvbnN0IGFuY2hvciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGFuY2hvcklkKVxuICAgICAgICBpZiAoYW5jaG9yKSB7XG4gICAgICAgICAgY29uc3QgY2FjaGVkRGVzY3JpcHRvciA9IGdfdW5hbmNob3JlZExlZGdlclthbmNob3JJZF1cbiAgICAgICAgICBkZWxldGUgZ191bmFuY2hvcmVkTGVkZ2VyW2FuY2hvcklkXVxuICAgICAgICAgIGJ1ZmZlci5wdXNoKGNhY2hlZERlc2NyaXB0b3IpXG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgaWYgKGJ1ZmZlci5sZW5ndGgpIHtcbiAgICAgICAgcmV0dXJuIE8uZnJvbShidWZmZXIpXG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gTy5uZXZlcigpXG4gICAgICB9XG4gICAgfSlcblxuICBjb25zdCBwYXRjaCQgPSBPLm1lcmdlKGRlc2NyaXB0b3IkLCBmcm9tTXV0YXRpb24kKVxuICAgIC5tZXJnZU1hcChkZXNjcmlwdG9yID0+IHtcbiAgICAgIHJldHVybiBkaWZmQW5kUGF0Y2goZGVzY3JpcHRvcilcbiAgICB9KVxuICAgIC5wdWJsaXNoKCkucmVmQ291bnQoKVxuXG4gIHJldHVybiBwYXRjaCRcbn1cblxuZnVuY3Rpb24gbWFrZVF1ZXJ5UmVuZGVyZWRGaWx0ZXIoZGlmZk1hcCQsIGV2ZW50JCwgcnVuU0EpIHtcbiAgcmV0dXJuIGZ1bmN0aW9uIHF1ZXJ5UmVuZGVyZWRGaWx0ZXIoaW5mbykge1xuICAgIGNvbnN0IG91dCQgPSBkaWZmTWFwJC5zd2l0Y2hNYXAoZGlmZk1hcCA9PiB7XG4gICAgICByZXR1cm4gZXZlbnQkLm1hcChlID0+IHtcbiAgICAgICAgY29uc3QgbGF5ZXJzID0gaW5mbyAmJiBpbmZvLmxheWVycyAmJiBpbmZvLmxheWVycy5maWx0ZXIoeCA9PiBkaWZmTWFwLmdldExheWVyKHgpKVxuICAgICAgICBpZiAobGF5ZXJzKSB7XG4gICAgICAgICAgY29uc3QgZmVhdHVyZXMgPSBkaWZmTWFwLnF1ZXJ5UmVuZGVyZWRGZWF0dXJlcyhlLnBvaW50LCB7bGF5ZXJzfSlcbiAgICAgICAgICByZXR1cm4gZmVhdHVyZXNcbiAgICAgICAgfSBcblxuICAgICAgICByZXR1cm4gdW5kZWZpbmVkXG4gICAgICB9KVxuICAgICAgLy8uZmlsdGVyKHggPT4geC5sZW5ndGgpXG4gICAgICAucHVibGlzaCgpLnJlZkNvdW50KClcbiAgICB9KVxuXG4gICAgY29uc3Qgb2JzZXJ2YWJsZSA9IHJ1blNBID8gcnVuU0EuYWRhcHQob3V0JCwgcnhqc1NBLnN0cmVhbVN1YnNjcmliZSkgOiBvdXQkXG4gICAgcmV0dXJuIG9ic2VydmFibGVcbiAgfVxufVxuXG5mdW5jdGlvbiBtYWtlRXZlbnRzU2VsZWN0b3IoZGlmZk1hcCQsIHJ1blNBKSB7XG4gIHJldHVybiBmdW5jdGlvbiBldmVudHMoZXZlbnROYW1lKSB7XG4gICAgaWYgKHR5cGVvZiBldmVudE5hbWUgIT09IGBzdHJpbmdgKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYE1hcGJveEdMIGRyaXZlcidzIGV2ZW50cygpIGV4cGVjdHMgYXJndW1lbnQgdG8gYmUgYSBgICtcbiAgICAgICAgYHN0cmluZyByZXByZXNlbnRpbmcgdGhlIGV2ZW50IHR5cGUgdG8gbGlzdGVuIGZvci5gKVxuICAgIH1cblxuICAgIGNvbnN0IG91dCQgPSBkaWZmTWFwJC5zd2l0Y2hNYXAoZGlmZk1hcCA9PiB7XG4gICAgICByZXR1cm4gZnJvbUV2ZW50KGRpZmZNYXAsIGV2ZW50TmFtZSlcbiAgICB9KVxuICAgIC5wdWJsaXNoKCkucmVmQ291bnQoKVxuXG4gICAgY29uc3Qgb2JzZXJ2YWJsZSA9IHJ1blNBID8gcnVuU0EuYWRhcHQob3V0JCwgcnhqc1NBLnN0cmVhbVN1YnNjcmliZSkgOiBvdXQkXG4gICAgcmV0dXJuIHtcbiAgICAgIG9ic2VydmFibGUsXG4gICAgICBxdWVyeVJlbmRlcmVkRmlsdGVyOiBtYWtlUXVlcnlSZW5kZXJlZEZpbHRlcihkaWZmTWFwJCwgb3V0JCwgcnVuU0EpXG4gICAgfVxuICB9XG59XG5cbmZ1bmN0aW9uIG1ha2VNYXBTZWxlY3RvcihhcHBsaWVkJCwgcnVuU0EpIHtcbiAgcmV0dXJuIGZ1bmN0aW9uIHNlbGVjdChhbmNob3JJZCkge1xuICAgIC8vY29uc29sZS5sb2coYGNob29zaW5nIG1hcDogJHthbmNob3JJZH1gKVxuICAgIGNvbnN0IGRpZmZNYXAkID0gYXBwbGllZCRcbiAgICAgIC5tYXAoKCkgPT4gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoYW5jaG9ySWQpKVxuICAgICAgLmZpbHRlcih4ID0+ICEheClcbiAgICAgIC5kaXN0aW5jdFVudGlsQ2hhbmdlZChcbiAgICAgICAgeCA9PiB4ICYmICg8YW55PiB4KS5kaWZmTWFwXG4gICAgICApXG4gICAgICAubWFwKHggPT4geC5kaWZmTWFwKVxuICAgICAgLnB1Ymxpc2hSZXBsYXkoMSkucmVmQ291bnQoKVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIG9ic2VydmFibGU6IHJ1blNBID8gcnVuU0EuYWRhcHQoZGlmZk1hcCQsIHJ4anNTQS5zdHJlYW1TdWJzY3JpYmUpIDogZGlmZk1hcCQsXG4gICAgICBldmVudHM6IG1ha2VFdmVudHNTZWxlY3RvcihkaWZmTWFwJCwgcnVuU0EpXG4gICAgfVxuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBtYWtlTWFwSlNPTkRyaXZlcihhY2Nlc3NUb2tlbjogc3RyaW5nKSB7XG4gIGlmICghYWNjZXNzVG9rZW4gfHwgKHR5cGVvZihhY2Nlc3NUb2tlbikgIT09ICdzdHJpbmcnKSkgdGhyb3cgbmV3IEVycm9yKGBNYXBET01Ecml2ZXIgcmVxdWlyZXMgYW4gYWNjZXNzIHRva2VuLmApXG5cbiAgaWYoIW1hcGJveGdsLmFjY2Vzc1Rva2VuKSB7XG4gICAgbWFwYm94Z2wuYWNjZXNzVG9rZW4gPSBhY2Nlc3NUb2tlblxuICB9XG5cbiAgZnVuY3Rpb24gbWFwSlNPTkRyaXZlcihkZXNjcmlwdG9yJCwgcnVuU0EpIHtcblxuICAgIGxldCBhZGFwdGVkJFxuICAgIGlmIChydW5TQSkge1xuICAgICAgYWRhcHRlZCQgPSByeGpzU0EuYWRhcHQoZGVzY3JpcHRvciQsIHJ1blNBLnN0cmVhbVN1YnNjcmliZSlcbiAgICAgICAgLnB1Ymxpc2hSZXBsYXkoMSkucmVmQ291bnQoKVxuICAgIH0gZWxzZSB7XG4gICAgICBhZGFwdGVkJCA9IGRlc2NyaXB0b3IkXG4gICAgICAgIC5wdWJsaXNoUmVwbGF5KDEpLnJlZkNvdW50KClcbiAgICB9XG5cbiAgICBjb25zdCAgYXBwbGllZCQgPSByZW5kZXJSYXdSb290RWxlbSQoYWRhcHRlZCQsIGFjY2Vzc1Rva2VuKVxuXG5cbiAgICBhcHBsaWVkJC5zdWJzY3JpYmUoKVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIHNlbGVjdDogbWFrZU1hcFNlbGVjdG9yKGFwcGxpZWQkLCBydW5TQSlcbiAgICB9XG4gIH1cblxuICA7KDxhbnk+IG1hcEpTT05Ecml2ZXIpLnN0cmVhbUFkYXB0ZXIgPSByeGpzU0FcbiAgcmV0dXJuIG1hcEpTT05Ecml2ZXJcbn0iXX0=