"use strict";
var rxjs_1 = require("rxjs");
var jsondiffpatch = require("jsondiffpatch");
var rxjs_adapter_1 = require("@cycle/rxjs-adapter");
var g_unanchoredLedger = {};
function fromEvent(diffMap, eventName) {
    return rxjs_1.Observable.create(function (observer) {
        var handler = function (e) { return observer.next(e); };
        diffMap.on(eventName, handler);
        return function () { return diffMap.off(eventName, handler); };
    });
}
function diff(previous, current) {
    return jsondiffpatch.diff(previous, current);
}
function patch(diffMap, previousDescriptor, descriptor) {
    var delta = diff(previousDescriptor, descriptor);
    // console.log(`previous`, previousDescriptor)
    // console.log(`current`, descriptor)
    // console.log(`delta`, delta)
    if (delta) {
        var controls = delta.controls, map = delta.map, sources = delta.sources, layers = delta.layers, canvas = delta.canvas, options = delta.options;
        if (controls) {
            patchControls(diffMap, controls, descriptor.controls);
        }
        if (map) {
            patchMap(diffMap, map, descriptor.map, options);
        }
        if (sources) {
            patchSources(diffMap, sources, descriptor.sources);
        }
        if (layers) {
            patchLayers(diffMap, layers, descriptor.layers);
        }
        if (canvas) {
            patchCanvas(diffMap, canvas, descriptor.canvas);
        }
    }
    return descriptor;
}
function patchMap(diffMap, mapDelta, mapDescriptor, options) {
    if (mapDelta.zoom) {
        diffMap.easeTo({
            center: diffMap.getCenter(),
            zoom: mapDescriptor.zoom
        });
    }
    if (mapDelta.center) {
        var newCenter = mapDescriptor.center;
        if (options && options.offset) {
            var _a = options.offset, x = _a[0], y = _a[1];
            var coordinates = diffMap.project(mapDescriptor.center);
            var shiftedCenter = coordinates.sub({ x: x, y: y });
            newCenter = diffMap.unproject(shiftedCenter);
        }
        diffMap.easeTo({
            center: newCenter,
            zoom: diffMap.getZoom()
        });
    }
    if (mapDelta.dragPan) {
        //console.log(`dragPan`, mapDescriptor.dragPan)
        if (mapDescriptor.dragPan) {
            //console.log(`enabling drag`)
            diffMap.dragPan.enable();
        }
        else {
            //console.log(`disabling drag`)
            diffMap.dragPan.disable();
        }
    }
}
function patchSources(diffMap, delta, descriptor) {
    if (delta) {
        if (Array.isArray(delta)) {
            var len = delta.length;
            var vals = void 0;
            switch (len) {
                case 1:
                    vals = delta[0];
                    for (var key in vals) {
                        if (vals.hasOwnProperty(key)) {
                            var data = vals[key];
                            diffMap.addSource(key, data);
                        }
                    }
                    break;
                case 2:
                    vals = delta[0];
                    for (var key in vals) {
                        if (vals.hasOwnProperty(key)) {
                            diffMap.removeSource(key);
                            diffMap.addSource(key, descriptor[key]);
                        }
                    }
                    break;
                case 3:
                    vals = delta[0];
                    for (var key in vals) {
                        if (vals.hasOwnProperty(key)) {
                            diffMap.removeSource(key);
                        }
                    }
                    break;
                default:
                    throw new Error("Invalid delta length");
            }
        }
        else {
            for (var key in delta) {
                var newData = descriptor[key].data;
                diffMap.getSource(key).setData(newData);
            }
        }
    }
}
function patchLayers(diffMap, delta, descriptor) {
    if (delta) {
        if (Array.isArray(delta)) {
            var len = delta.length;
            var vals = void 0;
            switch (len) {
                case 1:
                    vals = delta[0];
                    for (var key in vals) {
                        if (vals.hasOwnProperty(key)) {
                            var data = vals[key];
                            diffMap.addLayer(data);
                        }
                    }
                    break;
                case 2:
                    vals = delta[0];
                    for (var key in vals) {
                        if (vals.hasOwnProperty(key)) {
                            diffMap.removeLayer(key);
                            diffMap.addLayer(descriptor[key]);
                        }
                    }
                    break;
                case 3:
                    vals = delta[0];
                    for (var key in vals) {
                        if (vals.hasOwnProperty(key)) {
                            diffMap.removeLayer(key);
                        }
                    }
                    break;
                default:
                    throw new Error("Invalid delta length");
            }
        }
    }
}
function patchControls(diffMap, delta, descriptor) {
}
function patchCanvas(diffMap, delta, descriptor) {
    if (delta) {
        if (descriptor.style && descriptor.style.cursor) {
            diffMap.getCanvas().style.cursor = descriptor.style.cursor;
        }
    }
}
function diffAndPatch(descriptor) {
    if (typeof descriptor === "undefined" || !descriptor) {
        return undefined;
    }
    var anchorId = descriptor.map.container;
    var anchor = document.getElementById(anchorId);
    if (!anchor) {
        g_unanchoredLedger[anchorId] = descriptor;
        return rxjs_1.Observable.never();
    }
    else {
        var diffMap_1 = anchor.diffMap;
        if (!diffMap_1) {
            var controls_1 = descriptor.controls, map = descriptor.map, sources_1 = descriptor.sources, layers_1 = descriptor.layers, canvas_1 = descriptor.canvas, options_1 = descriptor.options;
            diffMap_1 = new mapboxgl.Map(descriptor.map);
            return rxjs_1.Observable.create(function (observer) {
                diffMap_1.on('load', function () {
                    /*** HACK to allow for enable/disable from outset */
                    diffMap_1.dragPan.disable();
                    diffMap_1.dragPan.enable();
                    /*** End HACK */
                    if (controls_1) {
                    }
                    if (sources_1) {
                        for (var key in sources_1) {
                            if (sources_1.hasOwnProperty(key)) {
                                diffMap_1.addSource(key, sources_1[key]);
                            }
                        }
                    }
                    if (layers_1) {
                        for (var key in layers_1) {
                            if (layers_1.hasOwnProperty(key)) {
                                diffMap_1.addLayer(layers_1[key]);
                            }
                        }
                    }
                    if (canvas_1) {
                        if (canvas_1.style && canvas_1.style.cursor) {
                            diffMap_1.getCanvas().style.cursor = canvas_1.style.cursor;
                        }
                    }
                    if (options_1 && options_1.offset) {
                        var _a = options_1.offset, x = _a[0], y = _a[1];
                        var coordinates = diffMap_1.project(diffMap_1.getCenter());
                        var shiftedCenter = coordinates.sub({ x: x, y: y });
                        var newCenter = diffMap_1.unproject(shiftedCenter);
                        diffMap_1.setCenter(newCenter);
                    }
                    ;
                    anchor.diffMap = diffMap_1;
                    anchor.previousDescriptor = descriptor;
                    observer.next(descriptor);
                    observer.complete();
                });
            });
        }
        else {
            var previousDescriptor = anchor.previousDescriptor;
            var out = rxjs_1.Observable.of(patch(diffMap_1, previousDescriptor, descriptor));
            anchor.previousDescriptor = descriptor;
            return out;
        }
    }
}
function renderRawRootElem$(descriptor$, accessToken) {
    var mutation$ = rxjs_1.Observable.create(function (observer) {
        var mObserver = new MutationObserver(function (m) { return observer.next(m); });
        var config = { childList: true, subtree: true };
        mObserver.observe(document, config);
        return function () { mObserver.disconnect(); };
    });
    var fromMutation$ = mutation$
        .switchMap(function () {
        var anchorId;
        var buffer = [];
        for (anchorId in g_unanchoredLedger) {
            var anchor = document.getElementById(anchorId);
            if (anchor) {
                var cachedDescriptor = g_unanchoredLedger[anchorId];
                delete g_unanchoredLedger[anchorId];
                buffer.push(cachedDescriptor);
            }
        }
        if (buffer.length) {
            return rxjs_1.Observable.from(buffer);
        }
        else {
            return rxjs_1.Observable.never();
        }
    });
    var patch$ = rxjs_1.Observable.merge(descriptor$, fromMutation$)
        .mergeMap(function (descriptor) {
        return diffAndPatch(descriptor);
    })
        .publish().refCount();
    return patch$;
}
function makeQueryRenderedFilter(diffMap$, event$, runSA) {
    return function queryRenderedFilter(info) {
        var out$ = diffMap$.switchMap(function (diffMap) {
            return event$.map(function (e) {
                var layers = info && info.layers && info.layers.filter(function (x) { return diffMap.getLayer(x); });
                if (layers) {
                    var features = diffMap.queryRenderedFeatures(e.point, { layers: layers });
                    return features;
                }
                return undefined;
            })
                .publish().refCount();
        });
        var observable = runSA ? runSA.adapt(out$, rxjs_adapter_1.default.streamSubscribe) : out$;
        return observable;
    };
}
function makeEventsSelector(diffMap$, runSA) {
    return function events(eventName) {
        if (typeof eventName !== "string") {
            throw new Error("MapboxGL driver's events() expects argument to be a " +
                "string representing the event type to listen for.");
        }
        var out$ = diffMap$.switchMap(function (diffMap) {
            return fromEvent(diffMap, eventName);
        })
            .publish().refCount();
        var observable = runSA ? runSA.adapt(out$, rxjs_adapter_1.default.streamSubscribe) : out$;
        return {
            observable: observable,
            queryRenderedFilter: makeQueryRenderedFilter(diffMap$, out$, runSA)
        };
    };
}
function makeMapSelector(applied$, runSA) {
    return function select(anchorId) {
        //console.log(`choosing map: ${anchorId}`)
        var diffMap$ = applied$
            .map(function () { return document.getElementById(anchorId); })
            .filter(function (x) { return !!x; })
            .distinctUntilChanged(function (x) { return x && x.diffMap; })
            .map(function (x) { return x.diffMap; })
            .publishReplay(1).refCount();
        return {
            observable: runSA ? runSA.adapt(diffMap$, rxjs_adapter_1.default.streamSubscribe) : diffMap$,
            events: makeEventsSelector(diffMap$, runSA)
        };
    };
}
function makeMapJSONDriver(accessToken) {
    if (!accessToken || (typeof (accessToken) !== 'string'))
        throw new Error("MapDOMDriver requires an access token.");
    if (!mapboxgl.accessToken) {
        mapboxgl.accessToken = accessToken;
    }
    function mapJSONDriver(descriptor$, runSA) {
        var adapted$;
        if (runSA) {
            adapted$ = rxjs_adapter_1.default.adapt(descriptor$, runSA.streamSubscribe)
                .publishReplay(1).refCount();
        }
        else {
            adapted$ = descriptor$
                .publishReplay(1).refCount();
        }
        var applied$ = renderRawRootElem$(adapted$, accessToken);
        applied$.subscribe();
        return {
            select: makeMapSelector(applied$, runSA)
        };
    }
    ;
    mapJSONDriver.streamAdapter = rxjs_adapter_1.default;
    return mapJSONDriver;
}
exports.makeMapJSONDriver = makeMapJSONDriver;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFpbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9tYWluLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSw2QkFBb0M7QUFDcEMsNkNBQThDO0FBQzlDLG9EQUF3QztBQUV4QyxJQUFNLGtCQUFrQixHQUFHLEVBQUUsQ0FBQTtBQUU3QixtQkFBbUIsT0FBTyxFQUFFLFNBQVM7SUFDbkMsTUFBTSxDQUFDLGlCQUFDLENBQUMsTUFBTSxDQUFDLFVBQUEsUUFBUTtRQUN0QixJQUFNLE9BQU8sR0FBRyxVQUFBLENBQUMsSUFBSSxPQUFBLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQWhCLENBQWdCLENBQUE7UUFDckMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxTQUFTLEVBQUUsT0FBTyxDQUFDLENBQUE7UUFDOUIsTUFBTSxDQUFDLGNBQU0sT0FBQSxPQUFPLENBQUMsR0FBRyxDQUFDLFNBQVMsRUFBRSxPQUFPLENBQUMsRUFBL0IsQ0FBK0IsQ0FBQTtJQUM5QyxDQUFDLENBQUMsQ0FBQTtBQUNKLENBQUM7QUFFRCxjQUFjLFFBQVEsRUFBRSxPQUFPO0lBQzdCLE1BQU0sQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxPQUFPLENBQUMsQ0FBQTtBQUM5QyxDQUFDO0FBRUQsZUFBZSxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsVUFBVTtJQUNwRCxJQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsa0JBQWtCLEVBQUUsVUFBVSxDQUFDLENBQUE7SUFDbEQsOENBQThDO0lBQzlDLHFDQUFxQztJQUNyQyw4QkFBOEI7SUFDOUIsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztRQUNILElBQUEseUJBQVEsRUFBRSxlQUFHLEVBQUUsdUJBQU8sRUFBRSxxQkFBTSxFQUFFLHFCQUFNLEVBQUUsdUJBQU8sQ0FBUztRQUMvRCxFQUFFLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO1lBQ2IsYUFB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O1FBRXBCLE1BQU0sQ0FBQztZQUNMLE1BQU0sRUFBRSxlQUFlLENBQUMsUUFBUSxFQUFFLEtBQUssQ0FBQztTQUN6QyxDQUFBO0lBQ0gsQ0FBQztJQUVELENBQUM7SUFBTyxhQUFjLENBQUMsYUFBYSxHQUFHLHNCQUFNLENBQUE7SUFDN0MsTUFBTSxDQUFDLGFBQWEsQ0FBQTtBQUN0QixDQUFDO0FBOUJELDhDQThCQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7T2JzZXJ2YWJsZSBhcyBPfSBmcm9tICdyeGpzJ1xuaW1wb3J0ICogYXMganNvbmRpZmZwYXRjaCBmcm9tICdqc29uZGlmZnBhdGNoJ1xuaW1wb3J0IHJ4anNTQSBmcm9tICdAY3ljbGUvcnhqcy1hZGFwdGVyJ1xuXG5jb25zdCBnX3VuYW5jaG9yZWRMZWRnZXIgPSB7fVxuXG5mdW5jdGlvbiBmcm9tRXZlbnQoZGlmZk1hcCwgZXZlbnROYW1lKSB7XG4gIHJldHVybiBPLmNyZWF0ZShvYnNlcnZlciA9PiB7XG4gICAgY29uc3QgaGFuZGxlciA9IGUgPT4gb2JzZXJ2ZXIubmV4dChlKVxuICAgIGRpZmZNYXAub24oZXZlbnROYW1lLCBoYW5kbGVyKVxuICAgIHJldHVybiAoKSA9PiBkaWZmTWFwLm9mZihldmVudE5hbWUsIGhhbmRsZXIpXG4gIH0pXG59XG5cbmZ1bmN0aW9uIGRpZmYocHJldmlvdXMsIGN1cnJlbnQpIHtcbiAgcmV0dXJuIGpzb25kaWZmcGF0Y2guZGlmZihwcmV2aW91cywgY3VycmVudClcbn1cblxuZnVuY3Rpb24gcGF0Y2goZGlmZk1hcCwgcHJldmlvdXNEZXNjcmlwdG9yLCBkZXNjcmlwdG9yKSB7XG4gIGNvbnN0IGRlbHRhID0gZGlmZihwcmV2aW91c0Rlc2NyaXB0b3IsIGRlc2NyaXB0b3IpXG4gIC8vIGNvbnNvbGUubG9nKGBwcmV2aW91c2AsIHByZXZpb3VzRGVzY3JpcHRvcilcbiAgLy8gY29uc29sZS5sb2coYGN1cnJlbnRgLCBkZXNjcmlwdG9yKVxuICAvLyBjb25zb2xlLmxvZyhgZGVsdGFgLCBkZWx0YSlcbiAgaWYgKGRlbHRhKSB7XG4gICAgY29uc3Qge2NvbnRyb2xzLCBtYXAsIHNvdXJjZXMsIGxheWVycywgY2FudmFzLCBvcHRpb25zfSA9IGRlbHRhXG4gICAgaWYgKGNvbnRyb2xzKSB7XG4gICAgICBwYXRjaENvbnRyb2xzKGRpZmZNYXAsIGNvbnRyb2xzLCBkZXNjcmlwdG9yLmNvbnRyb2xzKVxuICAgIH1cblxuICAgIGlmIChtYXApIHtcbiAgICAgIHBhdGNoTWFwKGRpZmZNYXAsIG1hcCwgZGVzY3JpcHRvci5tYXAsIG9wdGlvbnMpXG4gICAgfVxuXG4gICAgaWYgKHNvdXJjZXMpIHtcbiAgICAgIHBhdGNoU291cmNlcyhkaWZmTWFwLCBzb3VyY2VzLCBkZXNjcmlwdG9yLnNvdXJjZXMpXG4gICAgfVxuXG4gICAgaWYgKGxheWVycykge1xuICAgICAgcGF0Y2hMYXllcnMoZGlmZk1hcCwgbGF5ZXJzLCBkZXNjcmlwdG9yLmxheWVycylcbiAgICB9XG5cbiAgICBpZiAoY2FudmFzKSB7XG4gICAgICBwYXRjaENhbnZhcyhkaWZmTWFwLCBjYW52YXMsIGRlc2NyaXB0b3IuY2FudmFzKVxuICAgIH1cbiAgfVxuXG4gIHJldHVybiBkZXNjcmlwdG9yXG59XG5cbmZ1bmN0aW9uIHBhdGNoTWFwKGRpZmZNYXAsIG1hcERlbHRhLCBtYXBEZXNjcmlwdG9yLCBvcHRpb25zKSB7XG4gIGlmIChtYXBEZWx0YS56b29tKSB7XG4gICAgZGlmZk1hcC5lYXNlVG8oe1xuICAgICAgY2VudGVyOiBkaWZmTWFwLmdldENlbnRlcigpLFxuICAgICAgem9vbTogbWFwRGVzY3JpcHRvci56b29tXG4gICAgfSlcbiAgfVxuXG4gIGlmIChtYXBEZWx0YS5jZW50ZXIpIHtcbiAgICBsZXQgbmV3Q2VudGVyID0gbWFwRGVzY3JpcHRvci5jZW50ZXJcbiAgICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLm9mZnNldCkge1xuICAgICAgY29uc3QgW3gsIHldID0gb3B0aW9ucy5vZmZzZXRcbiAgICAgIGNvbnN0IGNvb3JkaW5hdGVzID0gZGlmZk1hcC5wcm9qZWN0KG1hcERlc2NyaXB0b3IuY2VudGVyKVxuICAgICAgY29uc3Qgc2hpZnRlZENlbnRlciA9IGNvb3JkaW5hdGVzLnN1Yih7eCwgeX0pXG4gICAgICBuZXdDZW50ZXIgPSBkaWZmTWFwLnVucHJvamVjdChzaGlmdGVkQ2VudGVyKVxuICAgIH1cbiAgICBcbiAgICBkaWZmTWFwLmVhc2VUbyh7XG4gICAgICBjZW50ZXI6IG5ld0NlbnRlcixcbiAgICAgIHpvb206IGRpZmZNYXAuZ2V0Wm9vbSgpXG4gICAgfSlcbiAgfVxuXG5cbiAgaWYgKG1hcERlbHRhLmRyYWdQYW4pIHtcbiAgICAvL2NvbnNvbGUubG9nKGBkcmFnUGFuYCwgbWFwRGVzY3JpcHRvci5kcmFnUGFuKVxuICAgIGlmKG1hcERlc2NyaXB0b3IuZHJhZ1Bhbikge1xuICAgICAgLy9jb25zb2xlLmxvZyhgZW5hYmxpbmcgZHJhZ2ApXG4gICAgICBkaWZmTWFwLmRyYWdQYW4uZW5hYmxlKClcbiAgICB9IGVsc2Uge1xuICAgICAgLy9jb25zb2xlLmxvZyhgZGlzYWJsaW5nIGRyYWdgKVxuICAgICAgZGlmZk1hcC5kcmFnUGFuLmRpc2FibGUoKVxuICAgIH1cbiAgfVxufVxuXG5mdW5jdGlvbiBwYXRjaFNvdXJjZXMoZGlmZk1hcCwgZGVsdGEsIGRlc2NyaXB0b3IpIHtcbiAgaWYgKGRlbHRhKSB7XG4gICAgaWYgKEFycmF5LmlzQXJyYXkoZGVsdGEpKSB7XG4gICAgICBjb25zdCBsZW4gPSBkZWx0YS5sZW5ndGhcbiAgICAgIGxldCB2YWxzXG4gICAgICBzd2l0Y2ggKGxlbikge1xuICAgICAgICBjYXNlIDE6IC8vIEFkZFxuICAgICAgICAgIHZhbHMgPSBkZWx0YVswXVxuICAgICAgICAgIGZvciAobGV0IGtleSBpbiB2YWxzKSB7XG4gICAgICAgICAgICBpZiAodmFscy5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7XG4gICAgICAgICAgICAgIGNvbnN0IGRhdGEgPSB2YWxzW2tleV1cbiAgICAgICAgICAgICAgZGlmZk1hcC5hZGRTb3VyY2Uoa2V5LCBkYXRhKVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgICBicmVha1xuICAgICAgICBjYXNlIDI6IC8vIE1vZGlmeVxuICAgICAgICAgIHZhbHMgPSBkZWx0YVswXVxuICAgICAgICAgIGZvciAobGV0IGtleSBpbiB2YWxzKSB7XG4gICAgICAgICAgICBpZiAodmFscy5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7XG4gICAgICAgICAgICAgIGRpZmZNYXAucmVtb3ZlU291cmNlKGtleSlcbiAgICAgICAgICAgICAgZGlmZk1hcC5hZGRTb3VyY2Uoa2V5LCBkZXNjcmlwdG9yW2tleV0pXG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICAgIGJyZWFrXG4gICAgICAgIGNhc2UgMzogLy8gRGVsZXRlXG4gICAgICAgICAgdmFscyA9IGRlbHRhWzBdXG4gICAgICAgICAgZm9yIChsZXQga2V5IGluIHZhbHMpIHtcbiAgICAgICAgICAgIGlmICh2YWxzLmhhc093blByb3BlcnR5KGtleSkpIHtcbiAgICAgICAgICAgICAgZGlmZk1hcC5yZW1vdmVTb3VyY2Uoa2V5KVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgICBicmVha1xuICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIkludmFsaWQgZGVsdGEgbGVuZ3RoXCIpXG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGZvciAobGV0IGtleSBpbiBkZWx0YSkge1xuICAgICAgICBjb25zdCBuZXdEYXRhID0gZGVzY3JpcHRvcltrZXldLmRhdGFcbiAgICAgICAgZGlmZk1hcC5nZXRTb3VyY2Uoa2V5KS5zZXREYXRhKG5ld0RhdGEpXG4gICAgICB9XG4gICAgfVxuICB9XG59XG5cbmZ1bmN0aW9uIHBhdGNoTGF5ZXJzKGRpZmZNYXAsIGRlbHRhLCBkZXNjcmlwdG9yKSB7XG4gIGlmIChkZWx0YSkge1xuICAgIGlmIChBcnJheS5pc0FycmF5KGRlbHRhKSkge1xuICAgICAgY29uc3QgbGVuID0gZGVsdGEubGVuZ3RoXG4gICAgICBsZXQgdmFsc1xuICAgICAgc3dpdGNoIChsZW4pIHtcbiAgICAgICAgY2FzZSAxOiAvLyBBZGRcbiAgICAgICAgICB2YWxzID0gZGVsdGFbMF1cbiAgICAgICAgICBmb3IgKGxldCBrZXkgaW4gdmFscykge1xuICAgICAgICAgICAgaWYgKHZhbHMuaGFzT3duUHJvcGVydHkoa2V5KSkge1xuICAgICAgICAgICAgICBjb25zdCBkYXRhID0gdmFsc1trZXldXG4gICAgICAgICAgICAgIGRpZmZNYXAuYWRkTGF5ZXIoZGF0YSlcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgICAgYnJlYWtcbiAgICAgICAgY2FzZSAyOiAvLyBNb2RpZnlcbiAgICAgICAgICB2YWxzID0gZGVsdGFbMF1cbiAgICAgICAgICBmb3IgKGxldCBrZXkgaW4gdmFscykge1xuICAgICAgICAgICAgaWYgKHZhbHMuaGFzT3duUHJvcGVydHkoa2V5KSkge1xuICAgICAgICAgICAgICBkaWZmTWFwLnJlbW92ZUxheWVyKGtleSlcbiAgICAgICAgICAgICAgZGlmZk1hcC5hZGRMYXllcihkZXNjcmlwdG9yW2tleV0pXG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICAgIGJyZWFrXG4gICAgICAgIGNhc2UgMzogLy8gRGVsZXRlXG4gICAgICAgICAgdmFscyA9IGRlbHRhWzBdXG4gICAgICAgICAgZm9yIChsZXQga2V5IGluIHZhbHMpIHtcbiAgICAgICAgICAgIGlmICh2YWxzLmhhc093blByb3BlcnR5KGtleSkpIHtcbiAgICAgICAgICAgICAgZGlmZk1hcC5yZW1vdmVMYXllcihrZXkpXG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICAgIGJyZWFrXG4gICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiSW52YWxpZCBkZWx0YSBsZW5ndGhcIilcbiAgICAgIH1cbiAgICB9IFxuICAgIC8vIGVsc2Uge1xuICAgIC8vICAgLy8gZm9yIChsZXQga2V5IGluIGRlbHRhKSB7XG4gICAgLy8gICAvLyAgIGNvbnN0IG5ld0RhdGEgPSBkZXNjcmlwdG9yW2tleV0uZGF0YVxuICAgIC8vICAgLy8gICBkaWZmTWFwLmdldFNvdXJjZShrZXkpLnNldERhdGEobmV3RGF0YSlcbiAgICAvLyAgIC8vIH1cbiAgICAvLyB9XG4gIH1cbn1cblxuZnVuY3Rpb24gcGF0Y2hDb250cm9scyhkaWZmTWFwLCBkZWx0YSwgZGVzY3JpcHRvcikge1xuXG59XG5cbmZ1bmN0aW9uIHBhdGNoQ2FudmFzKGRpZmZNYXAsIGRlbHRhLCBkZXNjcmlwdG9yKSB7XG4gIGlmIChkZWx0YSkge1xuICAgIGlmIChkZXNjcmlwdG9yLnN0eWxlICYmIGRlc2NyaXB0b3Iuc3R5bGUuY3Vyc29yKSB7XG4gICAgICBkaWZmTWFwLmdldENhbnZhcygpLnN0eWxlLmN1cnNvciA9IGRlc2NyaXB0b3Iuc3R5bGUuY3Vyc29yXG4gICAgfVxuICB9XG59XG5cblxuZnVuY3Rpb24gZGlmZkFuZFBhdGNoKGRlc2NyaXB0b3IpIHtcbiAgaWYgKHR5cGVvZiBkZXNjcmlwdG9yID09PSBgdW5kZWZpbmVkYCB8fCAhZGVzY3JpcHRvcikgeyByZXR1cm4gdW5kZWZpbmVkIH1cblxuICBjb25zdCBhbmNob3JJZCA9IGRlc2NyaXB0b3IubWFwLmNvbnRhaW5lclxuICBjb25zdCBhbmNob3IgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChhbmNob3JJZClcblxuICBpZiAoIWFuY2hvcikge1xuICAgIGdfdW5hbmNob3JlZExlZGdlclthbmNob3JJZF0gPSBkZXNjcmlwdG9yXG4gICAgcmV0dXJuIE8ubmV2ZXIoKVxuICB9IGVsc2Uge1xuICAgIGxldCBkaWZmTWFwID0gKDxhbnk+IGFuY2hvcikuZGlmZk1hcFxuICAgIGlmICghZGlmZk1hcCkge1xuICAgICAgY29uc3Qge2NvbnRyb2xzLCBtYXAsIHNvdXJjZXMsIGxheWVycywgY2FudmFzLCBvcHRpb25zfSA9IGRlc2NyaXB0b3JcbiAgICAgIGRpZmZNYXAgPSBuZXcgbWFwYm94Z2wuTWFwKGRlc2NyaXB0b3IubWFwKVxuICAgICAgXG4gICAgICByZXR1cm4gTy5jcmVhdGUob2JzZXJ2ZXIgPT4ge1xuICAgICAgICBkaWZmTWFwLm9uKCdsb2FkJywgZnVuY3Rpb24gKCkge1xuICAgICAgICAgIC8qKiogSEFDSyB0byBhbGxvdyBmb3IgZW5hYmxlL2Rpc2FibGUgZnJvbSBvdXRzZXQgKi9cbiAgICAgICAgICBkaWZmTWFwLmRyYWdQYW4uZGlzYWJsZSgpXG4gICAgICAgICAgZGlmZk1hcC5kcmFnUGFuLmVuYWJsZSgpXG4gICAgICAgICAgLyoqKiBFbmQgSEFDSyAqL1xuXG4gICAgICAgICAgaWYgKGNvbnRyb2xzKSB7XG5cbiAgICAgICAgICB9XG5cbiAgICAgICAgICBpZiAoc291cmNlcykge1xuICAgICAgICAgICAgZm9yIChsZXQga2V5IGluIHNvdXJjZXMpIHtcbiAgICAgICAgICAgICAgaWYgKHNvdXJjZXMuaGFzT3duUHJvcGVydHkoa2V5KSkge1xuICAgICAgICAgICAgICAgIGRpZmZNYXAuYWRkU291cmNlKGtleSwgc291cmNlc1trZXldKVxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgaWYgKGxheWVycykge1xuICAgICAgICAgICAgZm9yIChsZXQga2V5IGluIGxheWVycykge1xuICAgICAgICAgICAgICBpZiAobGF5ZXJzLmhhc093blByb3BlcnR5KGtleSkpIHtcbiAgICAgICAgICAgICAgICBkaWZmTWFwLmFkZExheWVyKGxheWVyc1trZXldKVxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgaWYgKGNhbnZhcykge1xuICAgICAgICAgICAgaWYgKGNhbnZhcy5zdHlsZSAmJiBjYW52YXMuc3R5bGUuY3Vyc29yKSB7XG4gICAgICAgICAgICAgIGRpZmZNYXAuZ2V0Q2FudmFzKCkuc3R5bGUuY3Vyc29yID0gY2FudmFzLnN0eWxlLmN1cnNvclxuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cblxuICAgICAgICAgIGlmIChvcHRpb25zICYmIG9wdGlvbnMub2Zmc2V0KSB7XG4gICAgICAgICAgICBjb25zdCBbeCwgeV0gPSBvcHRpb25zLm9mZnNldFxuICAgICAgICAgICAgY29uc3QgY29vcmRpbmF0ZXMgPSBkaWZmTWFwLnByb2plY3QoZGlmZk1hcC5nZXRDZW50ZXIoKSlcbiAgICAgICAgICAgIGNvbnN0IHNoaWZ0ZWRDZW50ZXIgPSBjb29yZGluYXRlcy5zdWIoe3gsIHl9KVxuICAgICAgICAgICAgY29uc3QgbmV3Q2VudGVyID0gZGlmZk1hcC51bnByb2plY3Qoc2hpZnRlZENlbnRlcilcbiAgICAgICAgICAgIGRpZmZNYXAuc2V0Q2VudGVyKG5ld0NlbnRlcilcbiAgICAgICAgICB9XG5cblxuICAgICAgICAgIDsoPGFueT4gYW5jaG9yKS5kaWZmTWFwID0gZGlmZk1hcFxuICAgICAgICAgIDsoPGFueT4gYW5jaG9yKS5wcmV2aW91c0Rlc2NyaXB0b3IgPSBkZXNjcmlwdG9yXG4gICAgICAgICAgb2JzZXJ2ZXIubmV4dChkZXNjcmlwdG9yKVxuICAgICAgICAgIG9ic2VydmVyLmNvbXBsZXRlKClcbiAgICAgICAgfSlcbiAgICAgIH0pXG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IHByZXZpb3VzRGVzY3JpcHRvciA9ICg8YW55PiBhbmNob3IpLnByZXZpb3VzRGVzY3JpcHRvclxuICAgICAgY29uc3Qgb3V0ID0gTy5vZihwYXRjaChkaWZmTWFwLCBwcmV2aW91c0Rlc2NyaXB0b3IsIGRlc2NyaXB0b3IpKVxuICAgICAgOyg8YW55PiBhbmNob3IpLnByZXZpb3VzRGVzY3JpcHRvciA9IGRlc2NyaXB0b3JcbiAgICAgIHJldHVybiBvdXRcbiAgICB9XG4gIH1cbn1cblxuZnVuY3Rpb24gcmVuZGVyUmF3Um9vdEVsZW0kKGRlc2NyaXB0b3IkLCBhY2Nlc3NUb2tlbikge1xuXG4gIGNvbnN0IG11dGF0aW9uJCA9IE8uY3JlYXRlKG9ic2VydmVyID0+IHtcbiAgICBjb25zdCBtT2JzZXJ2ZXIgPSBuZXcgTXV0YXRpb25PYnNlcnZlcihtID0+IG9ic2VydmVyLm5leHQobSkpXG4gICAgY29uc3QgY29uZmlnID0geyBjaGlsZExpc3Q6IHRydWUsIHN1YnRyZWU6IHRydWUgfTtcbiAgICBtT2JzZXJ2ZXIub2JzZXJ2ZShkb2N1bWVudCwgY29uZmlnKTtcbiAgICByZXR1cm4gKCkgPT4geyBtT2JzZXJ2ZXIuZGlzY29ubmVjdCgpOyB9XG4gIH0pXG5cbiAgY29uc3QgZnJvbU11dGF0aW9uJCA9IG11dGF0aW9uJFxuICAgIC5zd2l0Y2hNYXAoKCkgPT4ge1xuICAgICAgbGV0IGFuY2hvcklkXG4gICAgICBjb25zdCBidWZmZXIgPSBbXVxuICAgICAgZm9yIChhbmNob3JJZCBpbiBnX3VuYW5jaG9yZWRMZWRnZXIpIHtcbiAgICAgICAgY29uc3QgYW5jaG9yID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoYW5jaG9ySWQpXG4gICAgICAgIGlmIChhbmNob3IpIHtcbiAgICAgICAgICBjb25zdCBjYWNoZWREZXNjcmlwdG9yID0gZ191bmFuY2hvcmVkTGVkZ2VyW2FuY2hvcklkXVxuICAgICAgICAgIGRlbGV0ZSBnX3VuYW5jaG9yZWRMZWRnZXJbYW5jaG9ySWRdXG4gICAgICAgICAgYnVmZmVyLnB1c2goY2FjaGVkRGVzY3JpcHRvcilcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBpZiAoYnVmZmVyLmxlbmd0aCkge1xuICAgICAgICByZXR1cm4gTy5mcm9tKGJ1ZmZlcilcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiBPLm5ldmVyKClcbiAgICAgIH1cbiAgICB9KVxuXG4gIGNvbnN0IHBhdGNoJCA9IE8ubWVyZ2UoZGVzY3JpcHRvciQsIGZyb21NdXRhdGlvbiQpXG4gICAgLm1lcmdlTWFwKGRlc2NyaXB0b3IgPT4ge1xuICAgICAgcmV0dXJuIGRpZmZBbmRQYXRjaChkZXNjcmlwdG9yKVxuICAgIH0pXG4gICAgLnB1Ymxpc2goKS5yZWZDb3VudCgpXG5cbiAgcmV0dXJuIHBhdGNoJFxufVxuXG5mdW5jdGlvbiBtYWtlUXVlcnlSZW5kZXJlZEZpbHRlcihkaWZmTWFwJCwgZXZlbnQkLCBydW5TQSkge1xuICByZXR1cm4gZnVuY3Rpb24gcXVlcnlSZW5kZXJlZEZpbHRlcihpbmZvKSB7XG4gICAgY29uc3Qgb3V0JCA9IGRpZmZNYXAkLnN3aXRjaE1hcChkaWZmTWFwID0+IHtcbiAgICAgIHJldHVybiBldmVudCQubWFwKGUgPT4ge1xuICAgICAgICBjb25zdCBsYXllcnMgPSBpbmZvICYmIGluZm8ubGF5ZXJzICYmIGluZm8ubGF5ZXJzLmZpbHRlcih4ID0+IGRpZmZNYXAuZ2V0TGF5ZXIoeCkpXG4gICAgICAgIGlmIChsYXllcnMpIHtcbiAgICAgICAgICBjb25zdCBmZWF0dXJlcyA9IGRpZmZNYXAucXVlcnlSZW5kZXJlZEZlYXR1cmVzKGUucG9pbnQsIHtsYXllcnN9KVxuICAgICAgICAgIHJldHVybiBmZWF0dXJlc1xuICAgICAgICB9IFxuXG4gICAgICAgIHJldHVybiB1bmRlZmluZWRcbiAgICAgIH0pXG4gICAgICAvLy5maWx0ZXIoeCA9PiB4Lmxlbmd0aClcbiAgICAgIC5wdWJsaXNoKCkucmVmQ291bnQoKVxuICAgIH0pXG5cbiAgICBjb25zdCBvYnNlcnZhYmxlID0gcnVuU0EgPyBydW5TQS5hZGFwdChvdXQkLCByeGpzU0Euc3RyZWFtU3Vic2NyaWJlKSA6IG91dCRcbiAgICByZXR1cm4gb2JzZXJ2YWJsZVxuICB9XG59XG5cbmZ1bmN0aW9uIG1ha2VFdmVudHNTZWxlY3RvcihkaWZmTWFwJCwgcnVuU0EpIHtcbiAgcmV0dXJuIGZ1bmN0aW9uIGV2ZW50cyhldmVudE5hbWUpIHtcbiAgICBpZiAodHlwZW9mIGV2ZW50TmFtZSAhPT0gYHN0cmluZ2ApIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgTWFwYm94R0wgZHJpdmVyJ3MgZXZlbnRzKCkgZXhwZWN0cyBhcmd1bWVudCB0byBiZSBhIGAgK1xuICAgICAgICBgc3RyaW5nIHJlcHJlc2VudGluZyB0aGUgZXZlbnQgdHlwZSB0byBsaXN0ZW4gZm9yLmApXG4gICAgfVxuXG4gICAgY29uc3Qgb3V0JCA9IGRpZmZNYXAkLnN3aXRjaE1hcChkaWZmTWFwID0+IHtcbiAgICAgIHJldHVybiBmcm9tRXZlbnQoZGlmZk1hcCwgZXZlbnROYW1lKVxuICAgIH0pXG4gICAgLnB1Ymxpc2goKS5yZWZDb3VudCgpXG5cbiAgICBjb25zdCBvYnNlcnZhYmxlID0gcnVuU0EgPyBydW5TQS5hZGFwdChvdXQkLCByeGpzU0Euc3RyZWFtU3Vic2NyaWJlKSA6IG91dCRcbiAgICByZXR1cm4ge1xuICAgICAgb2JzZXJ2YWJsZSxcbiAgICAgIHF1ZXJ5UmVuZGVyZWRGaWx0ZXI6IG1ha2VRdWVyeVJlbmRlcmVkRmlsdGVyKGRpZmZNYXAkLCBvdXQkLCBydW5TQSlcbiAgICB9XG4gIH1cbn1cblxuZnVuY3Rpb24gbWFrZU1hcFNlbGVjdG9yKGFwcGxpZWQkLCBydW5TQSkge1xuICByZXR1cm4gZnVuY3Rpb24gc2VsZWN0KGFuY2hvcklkKSB7XG4gICAgLy9jb25zb2xlLmxvZyhgY2hvb3NpbmcgbWFwOiAke2FuY2hvcklkfWApXG4gICAgY29uc3QgZGlmZk1hcCQgPSBhcHBsaWVkJFxuICAgICAgLm1hcCgoKSA9PiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChhbmNob3JJZCkpXG4gICAgICAuZmlsdGVyKHggPT4gISF4KVxuICAgICAgLmRpc3RpbmN0VW50aWxDaGFuZ2VkKFxuICAgICAgICB4ID0+IHggJiYgKDxhbnk+IHgpLmRpZmZNYXBcbiAgICAgIClcbiAgICAgIC5tYXAoeCA9PiB4LmRpZmZNYXApXG4gICAgICAucHVibGlzaFJlcGxheSgxKS5yZWZDb3VudCgpXG5cbiAgICByZXR1cm4ge1xuICAgICAgb2JzZXJ2YWJsZTogcnVuU0EgPyBydW5TQS5hZGFwdChkaWZmTWFwJCwgcnhqc1NBLnN0cmVhbVN1YnNjcmliZSkgOiBkaWZmTWFwJCxcbiAgICAgIGV2ZW50czogbWFrZUV2ZW50c1NlbGVjdG9yKGRpZmZNYXAkLCBydW5TQSlcbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIG1ha2VNYXBKU09ORHJpdmVyKGFjY2Vzc1Rva2VuOiBzdHJpbmcpIHtcbiAgaWYgKCFhY2Nlc3NUb2tlbiB8fCAodHlwZW9mKGFjY2Vzc1Rva2VuKSAhPT0gJ3N0cmluZycpKSB0aHJvdyBuZXcgRXJyb3IoYE1hcERPTURyaXZlciByZXF1aXJlcyBhbiBhY2Nlc3MgdG9rZW4uYClcblxuICBpZighbWFwYm94Z2wuYWNjZXNzVG9rZW4pIHtcbiAgICBtYXBib3hnbC5hY2Nlc3NUb2tlbiA9IGFjY2Vzc1Rva2VuXG4gIH1cblxuICBmdW5jdGlvbiBtYXBKU09ORHJpdmVyKGRlc2NyaXB0b3IkLCBydW5TQSkge1xuXG4gICAgbGV0IGFkYXB0ZWQkXG4gICAgaWYgKHJ1blNBKSB7XG4gICAgICBhZGFwdGVkJCA9IHJ4anNTQS5hZGFwdChkZXNjcmlwdG9yJCwgcnVuU0Euc3RyZWFtU3Vic2NyaWJlKVxuICAgICAgICAucHVibGlzaFJlcGxheSgxKS5yZWZDb3VudCgpXG4gICAgfSBlbHNlIHtcbiAgICAgIGFkYXB0ZWQkID0gZGVzY3JpcHRvciRcbiAgICAgICAgLnB1Ymxpc2hSZXBsYXkoMSkucmVmQ291bnQoKVxuICAgIH1cblxuICAgIGNvbnN0ICBhcHBsaWVkJCA9IHJlbmRlclJhd1Jvb3RFbGVtJChhZGFwdGVkJCwgYWNjZXNzVG9rZW4pXG5cblxuICAgIGFwcGxpZWQkLnN1YnNjcmliZSgpXG5cbiAgICByZXR1cm4ge1xuICAgICAgc2VsZWN0OiBtYWtlTWFwU2VsZWN0b3IoYXBwbGllZCQsIHJ1blNBKVxuICAgIH1cbiAgfVxuXG4gIDsoPGFueT4gbWFwSlNPTkRyaXZlcikuc3RyZWFtQWRhcHRlciA9IHJ4anNTQVxuICByZXR1cm4gbWFwSlNPTkRyaXZlclxufSJdfQ==